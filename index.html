<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jule√∏l-test</title>
    <style>
        body{font-family:system-ui;margin:16px}
        .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
        input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
        label{display:block;font-weight:600;margin-top:10px}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{border-bottom:1px solid #eee;padding:8px 4px;text-align:left}
        .right{text-align:right}
        .muted{color:#666;font-size:13px}
        .row{display:flex;gap:10px}
        .row>*{flex:1}
    </style>
</head>
<body>
<h1>Jule√∏l-test üçª</h1>

<div id="screenName" class="card">
    <h2>Navn</h2>
    <input id="name" placeholder="Skriv navnet ditt" autocomplete="name" />
    <button id="start">Start</button>
    <p class="muted">Lagrer fortl√∏pende i basen.</p>
</div>

<div id="screenRate" class="card" style="display:none">
    <div class="muted">Du: <b id="who"></b></div>

    <label>Velg √∏l</label>
    <select id="beerSelect">
        <option value="">Laster √∏l‚Ä¶</option>
    </select>
    <div class="muted" id="beerHelp"></div>

    <label>Smak (0‚Äì50)</label>
    <input id="smak" type="number" min="0" max="50" step="1" inputmode="numeric" />

    <label>Ettersmak (0‚Äì20)</label>
    <input id="ettersmak" type="number" min="0" max="20" step="1" inputmode="numeric" />

    <label>Farge (0‚Äì20)</label>
    <input id="farge" type="number" min="0" max="20" step="1" inputmode="numeric" />

    <label>Lukt (0‚Äì10)</label>
    <input id="lukt" type="number" min="0" max="10" step="1" inputmode="numeric" />

    <div class="muted" id="totalPreview" style="margin-top:10px">Total: 0 / 100</div>

    <div class="row" style="margin-top:12px">
        <button id="save">Lagre</button>
        <button id="reset" type="button">Bytt navn</button>
    </div>

    <div class="muted" id="status" style="margin-top:8px">‚Äî</div>

    <div class="card">
        <h3>Dine registreringer</h3>
        <table>
            <thead>
            <tr>
                <th>√òl</th>
                <th>Navn</th>
                <th class="right">Total</th>
            </tr>
            </thead>
            <tbody id="rows"></tbody>
        </table>
        <div class="muted">Tips: Velger du samme √∏l igjen og lagrer, oppdateres scoren.</div>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://lgwgsbdqsrfjmbcqomns.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxnd2dzYmRxc3Jmam1iY3FvbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MDMyMTEsImV4cCI6MjA4MTQ3OTIxMX0.nIGnmGVcgN_A4Vw-uDxszOzgoCAhAcS2WLR0VFERKts";
    const TASTING_ID = "7df0dc00-db94-421f-9a1d-3a0e3d5bad69";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const screenName = document.querySelector("#screenName");
    const screenRate = document.querySelector("#screenRate");
    const nameInput = document.querySelector("#name");
    const who = document.querySelector("#who");

    const beerSelect = document.querySelector("#beerSelect");
    const beerHelp = document.querySelector("#beerHelp");

    const smakEl = document.querySelector("#smak");
    const ettersmakEl = document.querySelector("#ettersmak");
    const fargeEl = document.querySelector("#farge");
    const luktEl = document.querySelector("#lukt");
    const totalPreview = document.querySelector("#totalPreview");

    const rows = document.querySelector("#rows");
    const status = document.querySelector("#status");

    const LS_NAME = "juleol_name_v1";

    let beers = [];            // [{beer_no, name}]
    let beerNameByNo = new Map();

    function clampInt(v, min, max) {
        const n = Number(v);
        if (!Number.isFinite(n)) return null;
        const i = Math.trunc(n);
        if (i < min || i > max) return null;
        return i;
    }

    function calcTotal100() {
        const smak = clampInt(smakEl.value, 0, 50) ?? 0;
        const ettersmak = clampInt(ettersmakEl.value, 0, 20) ?? 0;
        const farge = clampInt(fargeEl.value, 0, 20) ?? 0;
        const lukt = clampInt(luktEl.value, 0, 10) ?? 0;
        const total = smak + ettersmak + farge + lukt;
        totalPreview.textContent = `Total: ${total} / 100`;
        return total;
    }

    [smakEl, ettersmakEl, fargeEl, luktEl].forEach(el =>
        el.addEventListener("input", calcTotal100)
    );

    async function ensureSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) return session;
        const { data, error } = await supabase.auth.signInAnonymously();
        if (error) throw error;
        return data.session;
    }

    async function loadBeers() {
        beerSelect.innerHTML = `<option value="">Laster‚Ä¶</option>`;
        beerHelp.textContent = "";

        const { data, error } = await supabase
            .from("beers")
            .select("beer_no, name")
            .eq("tasting_id", TASTING_ID)
            .order("beer_no", { ascending: true });

        if (error) throw error;

        beers = data ?? [];
        beerNameByNo = new Map(beers.map(b => [b.beer_no, b.name]));

        if (beers.length === 0) {
            beerSelect.innerHTML = `<option value="">Ingen √∏l lagt inn enn√•</option>`;
            beerHelp.textContent = "Admin m√• legge inn √∏l i admin.html f√∏rst.";
            return;
        }

        beerSelect.innerHTML =
            `<option value="">Velg √∏l‚Ä¶</option>` +
            beers.map(b => `<option value="${b.beer_no}">${b.beer_no} ‚Äì ${escapeHtml(b.name)}</option>`).join("");

        beerHelp.textContent = `${beers.length} √∏l tilgjengelig.`;
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m]));
    }

    async function loadMyRatings() {
        const { data, error } = await supabase
            .from("ratings")
            .select("beer_no, score")
            .eq("tasting_id", TASTING_ID)
            .order("beer_no", { ascending: true });

        if (error) throw error;

        rows.innerHTML = "";
        for (const r of data) {
            const name = beerNameByNo.get(r.beer_no) ?? "";
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${r.beer_no}</td><td>${escapeHtml(name)}</td><td class="right">${r.score}</td>`;
            rows.appendChild(tr);
        }
    }

    async function boot() {
        if (!TASTING_ID || TASTING_ID.includes("PASTE_")) {
            alert("Du m√• sette TASTING_ID i index.html (UUID fra admin-siden).");
            return;
        }

        await ensureSession();
        await loadBeers();

        const savedName = localStorage.getItem(LS_NAME) || "";
        if (savedName) {
            who.textContent = savedName;
            screenName.style.display = "none";
            screenRate.style.display = "block";
            calcTotal100();
            await loadMyRatings();
        } else {
            nameInput.value = "";
        }
    }

    document.querySelector("#start").addEventListener("click", async () => {
        const n = nameInput.value.trim();
        if (!n) return alert("Skriv inn navn f√∏rst üôÇ");
        localStorage.setItem(LS_NAME, n);
        who.textContent = n;
        screenName.style.display = "none";
        screenRate.style.display = "block";
        await loadMyRatings();
        beerSelect.focus();
    });

    document.querySelector("#reset").addEventListener("click", () => {
        localStorage.removeItem(LS_NAME);
        location.reload();
    });

    document.querySelector("#save").addEventListener("click", async () => {
        const n = localStorage.getItem(LS_NAME);
        if (!n) return alert("Mangler navn");

        const beerNo = clampInt(beerSelect.value, 1, 9999);
        if (beerNo === null) return alert("Velg et √∏l fra lista");

        const smak = clampInt(smakEl.value, 0, 50);
        const ettersmak = clampInt(ettersmakEl.value, 0, 20);
        const farge = clampInt(fargeEl.value, 0, 20);
        const lukt = clampInt(luktEl.value, 0, 10);

        if (smak === null) return alert("Smak m√• v√¶re 0‚Äì50");
        if (ettersmak === null) return alert("Ettersmak m√• v√¶re 0‚Äì20");
        if (farge === null) return alert("Farge m√• v√¶re 0‚Äì20");
        if (lukt === null) return alert("Lukt m√• v√¶re 0‚Äì10");

        const total = smak + ettersmak + farge + lukt;

        status.textContent = "Lagrer‚Ä¶";

        const { error } = await supabase.from("ratings").upsert({
            tasting_id: TASTING_ID,
            beer_no: beerNo,
            display_name: n,
            smak,
            ettersmak,
            farge,
            lukt,
            score: total
        });

        if (error) {
            console.error(error);
            status.textContent = "Feil ved lagring";
            return alert("Feil ved lagring: " + error.message);
        }

        status.textContent = "Lagret: " + new Date().toLocaleTimeString();
        await loadMyRatings();
    });

    boot().catch(e => {
        console.error(e);
        alert("Oppstart-feil: " + e.message);
    });
</script>
</body>
</html>
