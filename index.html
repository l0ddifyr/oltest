<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Jule√∏l-test üçª</title>
    <style>
        :root {
            --primary: #d4a017;
            --secondary: #800000;
            --success: #2e7d32;
            --bg: #fcfcfc;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 12px;
            background-color: var(--bg);
            color: #333;
            -webkit-tap-highlight-color: transparent;
        }

        h1 { text-align: center; color: var(--secondary); margin: 20px 0; font-size: 28px; }

        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        /* Inputfelt og knapper */
        label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 13px; text-transform: uppercase; color: #666; }

        input#joinCode, input#name {
            width: 100%; height: 65px; border-radius: 15px; border: 2px solid #eee;
            font-size: 20px; font-weight: 600; box-sizing: border-box; margin-bottom: 20px;
            background: #f9f9f9; text-align: center;
        }

        input#joinCode { letter-spacing: 8px; font-size: 28px; text-transform: uppercase; }

        /* Slidere som fyller hele bredden */
        .score-row { width: 100%; margin-bottom: 28px; }
        .score-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .score-val {
            font-size: 24px; font-weight: 900; color: var(--primary);
            background: #fff9eb; padding: 4px 14px; border-radius: 10px; border: 1px solid #ffeeba;
        }

        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 18px; border-radius: 10px;
            background: #eee; outline: none; margin: 0; touch-action: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 36px; height: 36px; background: var(--primary);
            border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        /* Store, fete knapper */
        .btn-large {
            width: 100%; height: 70px; border-radius: 18px; border: none;
            font-size: 22px; font-weight: 800; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s; margin-top: 10px;
        }

        .btn-large:active { transform: scale(0.97); }

        #start { background: var(--primary); box-shadow: 0 5px 0 #b88a14; }
        #save { background: var(--success); box-shadow: 0 5px 0 #1e5622; margin-top: 20px; }
        #reset { background: #f1f1f1; color: #666; font-size: 16px; height: 50px; margin-top: 30px; box-shadow: none; border: 1px solid #ddd; }

        .beer-info-box {
            background: #fff5f5; border: 2px solid #feb2b2; border-radius: 15px;
            padding: 15px; text-align: center; margin-bottom: 20px;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 16px; }
        td { padding: 12px 5px; border-bottom: 1px solid #eee; }
        .muted { color: #666; font-size: 14px; text-align: center; margin-top: 10px; }
        .pill { padding: 5px 12px; background: #e8f5e9; color: #2e7d32; border-radius: 999px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<h1>Jule√∏l-test üçª</h1>

<div id="screenSetup" class="card">
    <label for="joinCode">Join-kode</label>
    <input id="joinCode" placeholder="KODE" maxlength="4" autotype="text" />

    <label for="name">Ditt Navn</label>
    <input id="name" placeholder="Skriv her..." autocomplete="name" />

    <button id="start" class="btn-large">START SMAKING üöÄ</button>
    <div class="muted" id="setupStatus">‚Äî</div>
</div>

<div id="screenRate" class="card" style="display:none">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span class="pill" id="livePill">Kobler...</span>
        <div class="muted" style="text-align:right"><b><span id="who">‚Äî</span></b> @ <span id="olsTitle">‚Äî</span></div>
    </div>

    <div class="beer-info-box">
        <div class="muted">N√• smaker vi:</div>
        <div style="font-size:36px; font-weight:900; color: var(--secondary);" id="currentBeerLabel">√òl #1</div>
        <div id="beerHelp" class="muted">√òl 1 av ?</div>
    </div>

    <div class="score-row">
        <div class="score-header"><label>Smak (0-50)</label><div class="score-val" id="val-smak">0</div></div>
        <input type="range" id="smak" min="0" max="50" value="0">
    </div>

    <div class="score-row">
        <div class="score-header"><label>Ettersmak (0-20)</label><div class="score-val" id="val-ettersmak">0</div></div>
        <input type="range" id="ettersmak" min="0" max="20" value="0">
    </div>

    <div class="score-row">
        <div class="score-header"><label>Farge (0-20)</label><div class="score-val" id="val-farge">0</div></div>
        <input type="range" id="farge" min="0" max="20" value="0">
    </div>

    <div class="score-row">
        <div class="score-header"><label>Lukt (0-10)</label><div class="score-val" id="val-lukt">0</div></div>
        <input type="range" id="lukt" min="0" max="10" value="0">
    </div>

    <div style="font-size:28px; font-weight:900; text-align: center; margin: 25px 0; color: var(--secondary);" id="totalPreview">0 / 100 poeng</div>

    <button id="save" class="btn-large">LAGRE POENG üíæ</button>
    <div id="status" style="text-align:center; margin-top:15px; font-weight:bold; color: var(--success); min-height: 24px;"></div>

    <div class="card" style="padding: 10px; margin-top:30px;">
        <h3 style="margin: 0 0 10px 0; font-size: 16px; text-align: center;">Dine registreringer</h3>
        <table>
            <tbody id="rows"></tbody>
        </table>
    </div>

    <button id="reset" class="btn-large">Avbryt / Logg ut</button>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM Elements
    const sSetup = document.getElementById("screenSetup"), sRate = document.getElementById("screenRate");
    const smakEl = document.getElementById("smak"), ettersmakEl = document.getElementById("ettersmak"), fargeEl = document.getElementById("farge"), luktEl = document.getElementById("lukt");
    const totalPreview = document.getElementById("totalPreview"), status = document.getElementById("status");

    let tastingId = null, currentBeerNo = 1, userId = null, channel = null;

    function updateUI() {
        document.getElementById('val-smak').textContent = smakEl.value;
        document.getElementById('val-ettersmak').textContent = ettersmakEl.value;
        document.getElementById('val-farge').textContent = fargeEl.value;
        document.getElementById('val-lukt').textContent = luktEl.value;
        const total = Number(smakEl.value) + Number(ettersmakEl.value) + Number(fargeEl.value) + Number(luktEl.value);
        totalPreview.textContent = `${total} / 100 poeng`;
    }

    [smakEl, ettersmakEl, fargeEl, luktEl].forEach(el => el.addEventListener("input", updateUI));

    async function ensureSession(){
        const { data:{session} } = await supabase.auth.getSession();
        if(session) { userId = session.user.id; }
        else {
            const { data } = await supabase.auth.signInAnonymously();
            userId = data.session.user.id;
        }
    }

    async function loadMeta(id) {
        const { data } = await supabase.from("tastings").select("*").eq("id", id).single();
        document.getElementById("olsTitle").textContent = data.title;
        currentBeerNo = data.current_beer_no || 1;
        document.getElementById("currentBeerLabel").textContent = `√òl #${currentBeerNo}`;
        document.getElementById("beerHelp").textContent = `√òl ${currentBeerNo} av ${data.total_beers}`;
    }

    async function loadMyRatings() {
        const { data } = await supabase.from("ratings").select("beer_no, score").eq("tasting_id", tastingId).eq("user_id", userId).order("beer_no", {ascending: false});
        document.getElementById("rows").innerHTML = data.map(r => `<tr><td>√òl #${r.beer_no}</td><td style="text-align:right"><b>${r.score} poeng</b></td></tr>`).join("");
    }

    async function loadCurrentRating() {
        const { data } = await supabase.from("ratings").select("*").eq("tasting_id", tastingId).eq("user_id", userId).eq("beer_no", currentBeerNo).maybeSingle();
        if(data) {
            smakEl.value = data.smak; ettersmakEl.value = data.ettersmak; fargeEl.value = data.farge; luktEl.value = data.lukt;
            status.textContent = "Du har stemt p√• denne.";
        } else {
            smakEl.value = ettersmakEl.value = fargeEl.value = luktEl.value = 0;
            status.textContent = "";
        }
        updateUI();
    }

    async function subscribe() {
        if(channel) supabase.removeChannel(channel);
        channel = supabase.channel(`ols-${tastingId}`)
            .on("postgres_changes", { event: "UPDATE", schema: "public", table: "tastings", filter: `id=eq.${tastingId}` }, async (payload) => {
                if(payload.new.current_beer_no !== currentBeerNo) {
                    currentBeerNo = payload.new.current_beer_no;
                    await loadMeta(tastingId);
                    await loadCurrentRating();
                }
            })
            .subscribe((s) => {
                document.getElementById("livePill").textContent = s === "SUBSCRIBED" ? "LIVE ‚úì" : "Offline";
                document.getElementById("livePill").style.background = s === "SUBSCRIBED" ? "#e8f5e9" : "#eee";
            });
    }

    document.getElementById("start").onclick = async () => {
        const code = document.getElementById("joinCode").value.toUpperCase().trim();
        const name = document.getElementById("name").value.trim();
        if(code.length !== 4 || !name) return alert("Sjekk kode og navn!");

        document.getElementById("setupStatus").textContent = "Kobler til...";
        const { data: ols } = await supabase.rpc("get_ols_by_join_code", { p_code: code });

        if(!ols || ols.length === 0) {
            document.getElementById("setupStatus").textContent = "Ugyldig kode";
            return;
        }

        tastingId = ols[0].id;
        localStorage.setItem("j_id", tastingId);
        localStorage.setItem("j_name", name);

        document.getElementById("who").textContent = name;
        await loadMeta(tastingId);
        await loadMyRatings();
        await loadCurrentRating();
        await subscribe();

        sSetup.style.display = "none";
        sRate.style.display = "block";
    };

    document.getElementById("save").onclick = async () => {
        status.textContent = "Lagrer...";
        const total = Number(smakEl.value) + Number(ettersmakEl.value) + Number(fargeEl.value) + Number(luktEl.value);
        const { error } = await supabase.from("ratings").upsert({
            tasting_id: tastingId, beer_no: currentBeerNo, user_id: userId,
            display_name: localStorage.getItem("j_name"),
            smak: smakEl.value, ettersmak: ettersmakEl.value, farge: fargeEl.value, lukt: luktEl.value, score: total
        }, { onConflict: "tasting_id,beer_no,user_id" });

        if(!error) {
            status.textContent = "‚úÖ Lagret!";
            await loadMyRatings();
        } else {
            status.textContent = "Feil ved lagring";
        }
    };

    document.getElementById("reset").onclick = () => { if(confirm("Logge ut?")) { localStorage.clear(); location.reload(); } };

    (async () => {
        await ensureSession();
        if(localStorage.getItem("j_id")) {
            tastingId = localStorage.getItem("j_id");
            document.getElementById("who").textContent = localStorage.getItem("j_name");
            await loadMeta(tastingId);
            await loadMyRatings();
            await loadCurrentRating();
            await subscribe();
            sSetup.style.display = "none";
            sRate.style.display = "block";
        }
        updateUI();
    })();
</script>

</body>
</html>