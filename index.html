<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jule√∏l-test üçª</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; background-color: #fcfcfc; color: #333; line-height: 1.5; }
        h1 { text-align: center; color: #800000; }
        .card { background: white; border: 1px solid #ddd; border-radius: 16px; padding: 20px; margin: 16px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        /* Slider Styling */
        .score-row { margin-bottom: 20px; }
        .score-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .score-header label { font-weight: 700; font-size: 16px; }
        .score-val { font-size: 22px; font-weight: 900; color: #d4a017; background: #fff9eb; padding: 4px 12px; border-radius: 8px; border: 1px solid #ffeeba; min-width: 45px; text-align: center; }
        input[type=range] { width: 100%; height: 12px; border-radius: 6px; background: #eee; outline: none; -webkit-appearance: none; margin: 10px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; background: #d4a017; border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        input[type=text], input[type=number], button { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        button { background: #d4a017; color: white; border: none; font-weight: 700; cursor: pointer; transition: transform 0.1s, background 0.2s; margin-top: 10px; }
        button:active { transform: scale(0.98); background: #b88a14; }
        button#reset { background: #f8f9fa; color: #666; border: 1px solid #ddd; margin-top: 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
        .right { text-align: right; }
        .muted { color: #666; font-size: 13px; text-align: center; }
        .pill { display: inline-block; padding: 4px 12px; background: #e8f5e9; color: #2e7d32; border-radius: 999px; font-size: 12px; font-weight: bold; }
        #status { font-weight: bold; text-align: center; color: #2e7d32; min-height: 20px; }
    </style>
</head>
<body>

<h1>Jule√∏l-test üçª</h1>

<div id="screenSetup" class="card">
    <h2>Velkommen!</h2>
    <label for="joinCode">Join-kode (4 tegn)</label>
    <input id="joinCode" placeholder="F.eks. K7M2" maxlength="4" autocapitalize="characters" autocomplete="off" style="margin-bottom: 15px;" />

    <label for="name">Ditt Navn</label>
    <input id="name" placeholder="Hvem smaker?" autocomplete="name" />

    <button id="start">Bli med i testen</button>
    <div class="muted" id="setupStatus" style="margin-top:10px">‚Äî</div>
</div>

<div id="screenRate" class="card" style="display:none">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <div>
            <div class="muted" style="text-align:left">Test: <b id="olsTitle">‚Äî</b></div>
            <div class="muted" style="text-align:left">Smaker: <b id="who">‚Äî</b></div>
        </div>
        <span class="pill" id="livePill">Kobler til...</span>
    </div>

    <div class="card" style="background: #fff5f5; border-color: #feb2b2; text-align: center;">
        <div class="muted" id="beerHelp">N√• smaker vi:</div>
        <div style="font-size:32px; font-weight:900; color: #c53030;" id="currentBeerLabel">√òl #‚Äî</div>
    </div>

    <div class="score-row">
        <div class="score-header"><label>Smak</label><div class="score-val" id="val-smak">0</div></div>
        <input type="range" id="smak" min="0" max="50" value="0">
    </div>

    <div class="score-row">
        <div class="score-header"><label>Ettersmak</label><div class="score-val" id="val-ettersmak">0</div></div>
        <input type="range" id="ettersmak" min="0" max="20" value="0">
    </div>

    <div class="score-row">
        <div class="score-header"><label>Farge / Utseende</label><div class="score-val" id="val-farge">0</div></div>
        <input type="range" id="farge" min="0" max="20" value="0">
    </div>

    <div class="score-row">
        <div class="score-header"><label>Lukt</label><div class="score-val" id="val-lukt">0</div></div>
        <input type="range" id="lukt" min="0" max="10" value="0">
    </div>

    <div style="font-size:24px; font-weight:800; text-align: center; margin: 20px 0;" id="totalPreview">Total: 0 / 100</div>

    <button id="save">Lagre poeng</button>
    <div id="status" style="margin-top:10px">‚Äî</div>

    <div class="card" style="padding: 10px;">
        <h3 style="margin-top:0">Dine stemmer</h3>
        <table>
            <thead><tr><th>√òl #</th><th class="right">Total</th></tr></thead>
            <tbody id="rows"></tbody>
        </table>
    </div>

    <button id="reset" type="button">Bytt bruker/rom</button>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const LS_STARTED = "juleol_started", LS_NAME = "juleol_name", LS_TASTING = "juleol_ols_id";
    const setup = document.querySelector("#screenSetup"), rate = document.querySelector("#screenRate");
    const joinCodeEl = document.querySelector("#joinCode"), nameEl = document.querySelector("#name"), setupStatus = document.querySelector("#setupStatus");
    const olsTitleEl = document.querySelector("#olsTitle"), whoEl = document.querySelector("#who"), currentBeerLabel = document.querySelector("#currentBeerLabel");
    const beerHelp = document.querySelector("#beerHelp"), livePill = document.querySelector("#livePill"), totalPreview = document.querySelector("#totalPreview");
    const smakEl = document.querySelector("#smak"), ettersmakEl = document.querySelector("#ettersmak"), fargeEl = document.querySelector("#farge"), luktEl = document.querySelector("#lukt");
    const rows = document.querySelector("#rows"), status = document.querySelector("#status");

    let tastingId = null, tastingTitle = "", totalBeers = 0, currentBeerNo = 1, userId = null, channel = null;

    // Oppdaterer visuelle tall ved siden av sliderne
    function updateSliderLabels() {
        document.getElementById('val-smak').textContent = smakEl.value;
        document.getElementById('val-ettersmak').textContent = ettersmakEl.value;
        document.getElementById('val-farge').textContent = fargeEl.value;
        document.getElementById('val-lukt').textContent = luktEl.value;
    }

    function calcTotal(){
        const t = Number(smakEl.value) + Number(ettersmakEl.value) + Number(fargeEl.value) + Number(luktEl.value);
        totalPreview.textContent = `Total: ${t} / 100`;
        updateSliderLabels();
        return t;
    }
    [smakEl,ettersmakEl,fargeEl,luktEl].forEach(el => el.addEventListener("input", calcTotal));

    async function ensureSession(){
        const { data:{session} } = await supabase.auth.getSession();
        if(session?.user){ userId = session.user.id; return; }
        const { data, error } = await supabase.auth.signInAnonymously();
        if(error) throw error;
        userId = data.session.user.id;
    }

    async function lookupByCode(code){
        const { data, error } = await supabase.rpc("get_ols_by_join_code", { p_code: code });
        if(error || !data || data.length === 0) throw new Error("Ugyldig join-kode");
        return data[0];
    }

    async function loadOlsMetaById(id){
        const { data, error } = await supabase.from("tastings").select("title,total_beers,current_beer_no").eq("id", id).single();
        if(error) throw error;
        tastingTitle = data.title; totalBeers = data.total_beers; currentBeerNo = data.current_beer_no ?? 1;
    }

    async function loadMyRatings(){
        const { data, error } = await supabase.from("ratings").select("beer_no, score").eq("tasting_id", tastingId).eq("user_id", userId).order("beer_no");
        if(error) throw error;
        rows.innerHTML = (data||[]).map(r => `<tr><td>√òl #${r.beer_no}</td><td class="right">${r.score} poeng</td></tr>`).join("");
    }

    async function loadMyRatingForCurrentBeer(){
        const { data, error } = await supabase.from("ratings").select("smak,ettersmak,farge,lukt").eq("tasting_id", tastingId).eq("user_id", userId).eq("beer_no", currentBeerNo).maybeSingle();
        if(error) throw error;
        if(!data){
            smakEl.value = ettersmakEl.value = fargeEl.value = luktEl.value = 0;
            status.textContent = "Ny smaking p√•begynt...";
        } else {
            smakEl.value = data.smak || 0; ettersmakEl.value = data.ettersmak || 0; fargeEl.value = data.farge || 0; luktEl.value = data.lukt || 0;
            status.textContent = "Du har stemt p√• denne (kan endres).";
        }
        calcTotal();
    }

    function renderCurrentBeer(){
        currentBeerLabel.textContent = `√òl #${currentBeerNo}`;
        beerHelp.textContent = totalBeers ? `√òl ${currentBeerNo} av ${totalBeers}` : `N√• smaker vi:`;
    }

    async function subscribeToCurrentBeer(){
        if(channel) supabase.removeChannel(channel);
        channel = supabase.channel(`ols-${tastingId}-live`)
            .on("postgres_changes", { event: "UPDATE", schema: "public", table: "tastings", filter: `id=eq.${tastingId}` }, async (payload) => {
                const nextNo = payload?.new?.current_beer_no;
                if(typeof nextNo === "number" && nextNo !== currentBeerNo){
                    currentBeerNo = nextNo;
                    renderCurrentBeer();
                    livePill.textContent = "LIVE ‚úì";
                    livePill.style.background = "#e8f5e9";
                    await loadMyRatingForCurrentBeer();
                }
            })
            .subscribe((s) => { livePill.textContent = (s === "SUBSCRIBED") ? "LIVE ‚úì" : "Kobler..."; });
    }

    document.querySelector("#start").addEventListener("click", async ()=>{
        try{
            const code = joinCodeEl.value.toUpperCase().replace(/[^A-Z0-9]/g, "").trim();
            const name = nameEl.value.trim();
            if (code.length !== 4) return alert("Join-kode m√• v√¶re 4 tegn");
            if(!name) return alert("Hva heter du?");

            setupStatus.textContent = "Sjekker tilgang...";
            const ols = await lookupByCode(code);
            tastingId = ols.id;
            localStorage.setItem(LS_STARTED,"1");
            localStorage.setItem(LS_NAME,name);
            localStorage.setItem(LS_TASTING,tastingId);

            await loadOlsMetaById(tastingId);
            olsTitleEl.textContent = tastingTitle;
            whoEl.textContent = name;
            renderCurrentBeer();
            await loadMyRatings();
            await loadMyRatingForCurrentBeer();
            await subscribeToCurrentBeer();

            setup.style.display="none";
            rate.style.display="block";
        }catch(e){ alert(e.message); setupStatus.textContent="‚Äî"; }
    });

    document.querySelector("#save").addEventListener("click", async ()=>{
        const total = calcTotal();
        status.textContent="Lagrer...";
        const { error } = await supabase.from("ratings").upsert({
            tasting_id: tastingId, beer_no: currentBeerNo, user_id: userId,
            display_name: localStorage.getItem(LS_NAME),
            smak: Number(smakEl.value), ettersmak: Number(ettersmakEl.value),
            farge: Number(fargeEl.value), lukt: Number(luktEl.value), score: total
        }, { onConflict: "tasting_id,beer_no,user_id" });

        if(error) return alert(error.message);
        await loadMyRatings();
        status.textContent="‚úÖ Lagret!";
        setTimeout(() => { if(status.textContent === "‚úÖ Lagret!") status.textContent = "‚Äî"; }, 3000);
    });

    document.querySelector("#reset").addEventListener("click", ()=>{
        if(confirm("Vil du virkelig bytte rom/navn?")){
            localStorage.clear();
            location.reload();
        }
    });

    (async ()=>{
        await ensureSession();
        if(localStorage.getItem(LS_STARTED)==="1"){
            tastingId = localStorage.getItem(LS_TASTING);
            const name = localStorage.getItem(LS_NAME) || "";
            whoEl.textContent = name;
            try {
                await loadOlsMetaById(tastingId);
                olsTitleEl.textContent = tastingTitle;
                renderCurrentBeer();
                await loadMyRatings();
                await loadMyRatingForCurrentBeer();
                await subscribeToCurrentBeer();
                setup.style.display="none";
                rate.style.display="block";
            } catch(e) { localStorage.clear(); }
        }
        calcTotal();
    })();
</script>
</body>
</html>