<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jule√∏l-test</title>
    <style>
        body{font-family:system-ui;margin:16px}
        .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
        input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
        label{display:block;font-weight:600;margin-top:10px}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{border-bottom:1px solid #eee;padding:8px 4px;text-align:left}
        .right{text-align:right}
        .muted{color:#666;font-size:13px}
        .row{display:flex;gap:10px;flex-wrap:wrap}
        .row>*{flex:1;min-width:160px}
    </style>
</head>
<body>
<h1>Jule√∏l-test üçª</h1>

<div class="card">
    <h2>Velg tasting</h2>
    <select id="tastingSelect">
        <option value="">Laster‚Ä¶</option>
    </select>
    <div class="muted" id="tastingInfo">‚Äî</div>
</div>

<div id="screenName" class="card">
    <h2>Navn</h2>
    <input id="name" placeholder="Skriv navnet ditt" autocomplete="name" />
    <button id="start">Start</button>
    <p class="muted">Blind tasting: du velger kun √∏l-nummer (1..N). √òlnavn vises etterp√•.</p>
</div>

<div id="screenRate" class="card" style="display:none">
    <div class="muted">Du: <b id="who"></b></div>

    <label>Velg √∏l-nummer</label>
    <select id="beerSelect">
        <option value="">Velg tasting f√∏rst‚Ä¶</option>
    </select>
    <div class="muted" id="beerHelp"></div>

    <label>Smak (0‚Äì50)</label>
    <input id="smak" type="number" min="0" max="50" step="1" inputmode="numeric" />

    <label>Ettersmak (0‚Äì20)</label>
    <input id="ettersmak" type="number" min="0" max="20" step="1" inputmode="numeric" />

    <label>Farge (0‚Äì20)</label>
    <input id="farge" type="number" min="0" max="20" step="1" inputmode="numeric" />

    <label>Lukt (0‚Äì10)</label>
    <input id="lukt" type="number" min="0" max="10" step="1" inputmode="numeric" />

    <div class="muted" id="totalPreview" style="margin-top:10px">Total: 0 / 100</div>

    <div class="row" style="margin-top:12px">
        <button id="save">Lagre / oppdater</button>
        <button id="reset" type="button">Bytt navn</button>
    </div>

    <div class="muted" id="status" style="margin-top:8px">‚Äî</div>

    <div class="card">
        <h3>Dine registreringer</h3>
        <table>
            <thead><tr><th>√òl #</th><th class="right">Total</th></tr></thead>
            <tbody id="rows"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const LS_NAME = "juleol_name_v1";
    const LS_TASTING = "juleol_tasting_id_v1";

    const tastingSelect = document.querySelector("#tastingSelect");
    const tastingInfo = document.querySelector("#tastingInfo");

    const screenName = document.querySelector("#screenName");
    const screenRate = document.querySelector("#screenRate");
    const nameInput = document.querySelector("#name");
    const who = document.querySelector("#who");

    const beerSelect = document.querySelector("#beerSelect");
    const beerHelp = document.querySelector("#beerHelp");

    const smakEl = document.querySelector("#smak");
    const ettersmakEl = document.querySelector("#ettersmak");
    const fargeEl = document.querySelector("#farge");
    const luktEl = document.querySelector("#lukt");
    const totalPreview = document.querySelector("#totalPreview");

    const rows = document.querySelector("#rows");
    const status = document.querySelector("#status");

    let sessionUserId = null;
    let currentTastingId = null;
    let totalBeers = 0;

    function clampInt(v, min, max) {
        const n = Number(v);
        if (!Number.isFinite(n)) return null;
        const i = Math.trunc(n);
        if (i < min || i > max) return null;
        return i;
    }

    function calcTotal100() {
        const smak = clampInt(smakEl.value, 0, 50) ?? 0;
        const ettersmak = clampInt(ettersmakEl.value, 0, 20) ?? 0;
        const farge = clampInt(fargeEl.value, 0, 20) ?? 0;
        const lukt = clampInt(luktEl.value, 0, 10) ?? 0;
        const total = smak + ettersmak + farge + lukt;
        totalPreview.textContent = `Total: ${total} / 100`;
        return total;
    }
    [smakEl, ettersmakEl, fargeEl, luktEl].forEach(el => el.addEventListener("input", calcTotal100));

    async function ensureSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
            sessionUserId = session.user.id;
            return session;
        }
        const { data, error } = await supabase.auth.signInAnonymously();
        if (error) throw error;
        sessionUserId = data.session.user.id;
        return data.session;
    }

    async function loadTastingsList() {
        const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, revealed, created_at")
            .order("created_at", { ascending: false });

        if (error) throw error;

        const saved = localStorage.getItem(LS_TASTING);

        tastingSelect.innerHTML =
            `<option value="">Velg‚Ä¶</option>` +
            (data ?? []).map(t => `<option value="${t.id}">${escapeHtml(t.title)} (${t.total_beers || 0} √∏l)</option>`).join("");

        if (saved && (data ?? []).some(t => t.id === saved)) {
            tastingSelect.value = saved;
        }
    }

    function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m]));
    }

    async function loadTastingMeta(tastingId) {
        const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, revealed")
            .eq("id", tastingId)
            .single();

        if (error) throw error;

        totalBeers = Number(data.total_beers || 0);
        tastingInfo.textContent = `${data.title} ‚Äî N=${totalBeers} ‚Äî ${data.revealed ? "REVEALED" : "skjult"}`;

        if (!totalBeers || totalBeers <= 0) {
            beerSelect.innerHTML = `<option value="">Admin har ikke satt N enn√•</option>`;
            beerHelp.textContent = "Be admin sette antall √∏l i admin-siden.";
            return;
        }

        const opts = [`<option value="">Velg‚Ä¶</option>`];
        for (let i = 1; i <= totalBeers; i++) opts.push(`<option value="${i}">√òl #${i}</option>`);
        beerSelect.innerHTML = opts.join("");
        beerHelp.textContent = `${totalBeers} √∏l i testen.`;
    }

    async function loadMyRatings() {
        if (!currentTastingId) return;
        const { data, error } = await supabase
            .from("ratings")
            .select("beer_no, score")
            .eq("tasting_id", currentTastingId)
            .eq("user_id", sessionUserId)
            .order("beer_no", { ascending: true });

        if (error) throw error;

        rows.innerHTML = "";
        for (const r of (data ?? [])) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${r.beer_no}</td><td class="right">${r.score}</td>`;
            rows.appendChild(tr);
        }
    }

    tastingSelect.addEventListener("change", async () => {
        const id = tastingSelect.value || null;
        currentTastingId = id;
        localStorage.setItem(LS_TASTING, id || "");

        if (!id) {
            tastingInfo.textContent = "Velg tasting‚Ä¶";
            beerSelect.innerHTML = `<option value="">Velg tasting f√∏rst‚Ä¶</option>`;
            return;
        }

        await loadTastingMeta(id);
        await loadMyRatings();
    });

    document.querySelector("#start").addEventListener("click", async () => {
        const n = nameInput.value.trim();
        if (!n) return alert("Skriv inn navn f√∏rst üôÇ");
        if (!currentTastingId) return alert("Velg tasting f√∏rst üôÇ");
        localStorage.setItem(LS_NAME, n);
        who.textContent = n;
        screenName.style.display = "none";
        screenRate.style.display = "block";
        await loadMyRatings();
        beerSelect.focus();
    });

    document.querySelector("#reset").addEventListener("click", () => {
        localStorage.removeItem(LS_NAME);
        location.reload();
    });

    document.querySelector("#save").addEventListener("click", async () => {
        const n = localStorage.getItem(LS_NAME);
        if (!n) return alert("Mangler navn");
        if (!currentTastingId) return alert("Velg tasting f√∏rst");

        const beerNo = clampInt(beerSelect.value, 1, totalBeers || 9999);
        if (beerNo === null) return alert("Velg √∏l-nummer");

        const smak = clampInt(smakEl.value, 0, 50);
        const ettersmak = clampInt(ettersmakEl.value, 0, 20);
        const farge = clampInt(fargeEl.value, 0, 20);
        const lukt = clampInt(luktEl.value, 0, 10);

        if (smak === null) return alert("Smak m√• v√¶re 0‚Äì50");
        if (ettersmak === null) return alert("Ettersmak m√• v√¶re 0‚Äì20");
        if (farge === null) return alert("Farge m√• v√¶re 0‚Äì20");
        if (lukt === null) return alert("Lukt m√• v√¶re 0‚Äì10");

        const total = smak + ettersmak + farge + lukt;
        status.textContent = "Lagrer‚Ä¶";

        const payload = {
            tasting_id: currentTastingId,
            beer_no: beerNo,
            user_id: sessionUserId,  // ‚úÖ viktig
            display_name: n,
            smak, ettersmak, farge, lukt,
            score: total
        };

        const { error } = await supabase
            .from("ratings")
            .upsert(payload, { onConflict: "tasting_id,beer_no,user_id" }); // ‚úÖ fix

        if (error) return alert("Feil ved lagring: " + error.message);

        status.textContent = "Lagret/oppdatert: " + new Date().toLocaleTimeString();
        await loadMyRatings();
    });

    async function boot() {
        await ensureSession();
        await loadTastingsList();

        const savedName = localStorage.getItem(LS_NAME) || "";
        if (savedName) {
            who.textContent = savedName;
            screenName.style.display = "none";
            screenRate.style.display = "block";
        }

        const savedTasting = tastingSelect.value || localStorage.getItem(LS_TASTING);
        if (savedTasting) {
            currentTastingId = savedTasting;
            tastingSelect.value = savedTasting;
            await loadTastingMeta(savedTasting);
            await loadMyRatings();
        } else {
            tastingInfo.textContent = "Velg tasting‚Ä¶";
        }

        calcTotal100();
    }

    boot().catch(e => alert("Oppstart-feil: " + e.message));
</script>
</body>
</html>
