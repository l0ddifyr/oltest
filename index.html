<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jule√∏l-test</title>
    <style>
        body{font-family:system-ui;margin:16px}
        .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
        input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
        label{display:block;font-weight:600;margin-top:10px}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
        .right{text-align:right}
        .muted{color:#666;font-size:13px}
        .row{display:flex;gap:10px;flex-wrap:wrap}
        .row>*{flex:1;min-width:160px}
        .pill{display:inline-block;padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    </style>
</head>
<body>

<h1>Jule√∏l-test üçª</h1>

<div id="screenSetup" class="card">
    <h2>Start</h2>

    <label for="joinCode">Join-kode</label>
    <input id="joinCode" placeholder="F.eks. K7M2" maxlength="4" autocapitalize="characters" autocomplete="off" />

    <label for="name">Navn</label>
    <input id="name" placeholder="Skriv navnet ditt" autocomplete="name" />

    <button id="start" style="margin-top:12px">Start</button>
    <div class="muted" id="setupStatus">‚Äî</div>
    <p class="muted">N√•r du har startet l√•ses √∏lsmakingen, og du scorer alltid ‚Äún√•v√¶rende √∏l‚Äù.</p>
</div>

<div id="screenRate" class="card" style="display:none">
    <div class="muted">√òlsmaking: <b id="olsTitle">‚Äî</b></div>
    <div class="muted">Du: <b id="who">‚Äî</b></div>

    <div class="card">
        <div class="row">
            <div>
                <div class="muted">N√• smaker vi</div>
                <div style="font-size:20px;font-weight:700" id="currentBeerLabel">√òl #‚Äî</div>
            </div>
            <div style="text-align:right">
                <span class="pill" id="livePill">Live</span>
            </div>
        </div>
        <div class="muted" id="beerHelp">‚Äî</div>
    </div>

    <!-- Skjult/disabled dropdown (for debug), men vi holder UI enkelt -->
    <select id="beerSelect" style="display:none">
        <option value="">Velg‚Ä¶</option>
    </select>

    <label>Smak (0‚Äì50)</label>
    <input id="smak" type="number" min="0" max="50" step="1" />

    <label>Ettersmak (0‚Äì20)</label>
    <input id="ettersmak" type="number" min="0" max="20" step="1" />

    <label>Farge (0‚Äì20)</label>
    <input id="farge" type="number" min="0" max="20" step="1" />

    <label>Lukt (0‚Äì10)</label>
    <input id="lukt" type="number" min="0" max="10" step="1" />

    <div class="muted" id="totalPreview" style="margin-top:10px">Total: 0 / 100</div>

    <div class="row" style="margin-top:12px">
        <button id="save">Lagre / oppdater</button>
        <button id="reset" type="button">Bytt navn / kode</button>
    </div>

    <div class="muted" id="status" style="margin-top:8px">‚Äî</div>

    <div class="card">
        <h3>Dine registreringer</h3>
        <table>
            <thead><tr><th>√òl #</th><th class="right">Total</th></tr></thead>
            <tbody id="rows"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const LS_STARTED = "juleol_started";
    const LS_NAME = "juleol_name";
    const LS_TASTING = "juleol_ols_id";

    const setup = document.querySelector("#screenSetup");
    const rate = document.querySelector("#screenRate");
    const joinCodeEl = document.querySelector("#joinCode");
    const nameEl = document.querySelector("#name");
    const setupStatus = document.querySelector("#setupStatus");

    const olsTitleEl = document.querySelector("#olsTitle");
    const whoEl = document.querySelector("#who");

    const currentBeerLabel = document.querySelector("#currentBeerLabel");
    const beerHelp = document.querySelector("#beerHelp");
    const livePill = document.querySelector("#livePill");

    const smakEl = document.querySelector("#smak");
    const ettersmakEl = document.querySelector("#ettersmak");
    const fargeEl = document.querySelector("#farge");
    const luktEl = document.querySelector("#lukt");
    const totalPreview = document.querySelector("#totalPreview");

    const rows = document.querySelector("#rows");
    const status = document.querySelector("#status");

    let tastingId = null;
    let tastingTitle = "";
    let totalBeers = 0;
    let currentBeerNo = 1;
    let userId = null;
    let channel = null;

    function clamp(v,min,max){
        const n = Number(v);
        if(!Number.isFinite(n) || n<min || n>max) return null;
        return Math.trunc(n);
    }

    function calcTotal(){
        const t =
            (clamp(smakEl.value,0,50)||0) +
            (clamp(ettersmakEl.value,0,20)||0) +
            (clamp(fargeEl.value,0,20)||0) +
            (clamp(luktEl.value,0,10)||0);
        totalPreview.textContent = `Total: ${t} / 100`;
        return t;
    }
    [smakEl,ettersmakEl,fargeEl,luktEl].forEach(el => el.addEventListener("input", calcTotal));

    async function ensureSession(){
        const { data:{session} } = await supabase.auth.getSession();
        if(session?.user){ userId = session.user.id; return; }
        const { data, error } = await supabase.auth.signInAnonymously();
        if(error) throw error;
        userId = data.session.user.id;
    }

    async function lookupByCode(code){
        const { data, error } = await supabase.rpc("get_ols_by_join_code", { p_code: code });
        if(error || !data || data.length === 0) throw new Error("Ugyldig join-kode");
        return data[0];
    }

    async function loadOlsMetaById(id){
        const { data, error } = await supabase
            .from("tastings")
            .select("title,total_beers,current_beer_no")
            .eq("id", id)
            .single();
        if(error) throw error;
        tastingTitle = data.title;
        totalBeers = data.total_beers;
        currentBeerNo = data.current_beer_no ?? 1;
    }

    async function loadMyRatings(){
        const { data, error } = await supabase
            .from("ratings")
            .select("beer_no, score")
            .eq("tasting_id", tastingId)
            .eq("user_id", userId)
            .order("beer_no");
        if(error) throw error;

        rows.innerHTML = "";
        for(const r of data||[]){
            rows.innerHTML += `<tr><td>${r.beer_no}</td><td class="right">${r.score}</td></tr>`;
        }
    }

    async function loadMyRatingForCurrentBeer(){
        const { data, error } = await supabase
            .from("ratings")
            .select("smak,ettersmak,farge,lukt")
            .eq("tasting_id", tastingId)
            .eq("user_id", userId)
            .eq("beer_no", currentBeerNo)
            .maybeSingle();
        if(error) throw error;

        if(!data){
            smakEl.value = ettersmakEl.value = fargeEl.value = luktEl.value = "";
            status.textContent = "Ny registrering for dette √∏let.";
        } else {
            smakEl.value = data.smak ?? "";
            ettersmakEl.value = data.ettersmak ?? "";
            fargeEl.value = data.farge ?? "";
            luktEl.value = data.lukt ?? "";
            status.textContent = "Tidligere registrering lastet (du kan oppdatere).";
        }
        calcTotal();
    }

    function renderCurrentBeer(){
        const safeNo = Math.max(1, Math.min(currentBeerNo, totalBeers || currentBeerNo));
        currentBeerNo = safeNo;

        currentBeerLabel.textContent = `√òl #${currentBeerNo}`;
        beerHelp.textContent = totalBeers ? `√òl ${currentBeerNo} av ${totalBeers}` : `√òl #${currentBeerNo}`;
    }

    async function subscribeToCurrentBeer(){
        if(channel){
            supabase.removeChannel(channel);
            channel = null;
        }

        channel = supabase.channel(`ols-${tastingId}-live`)
            .on("postgres_changes", {
                event: "UPDATE",
                schema: "public",
                table: "tastings",
                filter: `id=eq.${tastingId}`
            }, async (payload) => {
                const nextNo = payload?.new?.current_beer_no;
                if(typeof nextNo === "number" && nextNo !== currentBeerNo){
                    currentBeerNo = nextNo;
                    renderCurrentBeer();
                    livePill.textContent = "Live ‚úì";
                    await loadMyRatingForCurrentBeer();
                }
            })
            .subscribe((s) => {
                livePill.textContent = (s === "SUBSCRIBED") ? "Live ‚úì" : "Live‚Ä¶";
            });
    }

    document.querySelector("#start").addEventListener("click", async ()=>{
        try{
            const code = joinCodeEl.value.trim().toUpperCase();
            const name = nameEl.value.trim();
            if(code.length !== 4) return alert("Join-kode m√• v√¶re 4 tegn");
            if(!name) return alert("Skriv inn navn");

            setupStatus.textContent = "Sjekker kode‚Ä¶";
            const ols = await lookupByCode(code);

            tastingId = ols.id;
            localStorage.setItem(LS_STARTED,"1");
            localStorage.setItem(LS_NAME,name);
            localStorage.setItem(LS_TASTING,tastingId);

            await loadOlsMetaById(tastingId);

            olsTitleEl.textContent = tastingTitle;
            whoEl.textContent = name;

            renderCurrentBeer();
            await loadMyRatings();
            await loadMyRatingForCurrentBeer();
            await subscribeToCurrentBeer();

            setup.style.display="none";
            rate.style.display="block";
            setupStatus.textContent="‚Äî";
        }catch(e){
            alert(e.message);
            setupStatus.textContent="‚Äî";
        }
    });

    document.querySelector("#save").addEventListener("click", async ()=>{
        const smak = clamp(smakEl.value,0,50);
        const ettersmak = clamp(ettersmakEl.value,0,20);
        const farge = clamp(fargeEl.value,0,20);
        const lukt = clamp(luktEl.value,0,10);
        if([smak,ettersmak,farge,lukt].includes(null)) return alert("Ugyldige poeng");

        const total = calcTotal();
        status.textContent="Lagrer‚Ä¶";

        const { error } = await supabase
            .from("ratings")
            .upsert({
                tasting_id: tastingId,
                beer_no: currentBeerNo,
                user_id: userId,
                display_name: localStorage.getItem(LS_NAME),
                smak, ettersmak, farge, lukt,
                score: total
            }, { onConflict: "tasting_id,beer_no,user_id" });

        if(error) return alert(error.message);

        await loadMyRatings();
        status.textContent="Lagret ‚úÖ";
    });

    document.querySelector("#reset").addEventListener("click", ()=>{
        localStorage.removeItem(LS_STARTED);
        localStorage.removeItem(LS_NAME);
        localStorage.removeItem(LS_TASTING);
        if(channel) supabase.removeChannel(channel);
        location.reload();
    });

    // BOOT (refresh)
    (async ()=>{
        await ensureSession();

        if(localStorage.getItem(LS_STARTED)==="1"){
            tastingId = localStorage.getItem(LS_TASTING);
            const name = localStorage.getItem(LS_NAME) || "";
            whoEl.textContent = name;

            await loadOlsMetaById(tastingId);

            olsTitleEl.textContent = tastingTitle;
            renderCurrentBeer();
            await loadMyRatings();
            await loadMyRatingForCurrentBeer();
            await subscribeToCurrentBeer();

            setup.style.display="none";
            rate.style.display="block";
        }
        calcTotal();
    })();
</script>

</body>
</html>
