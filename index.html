<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jule√∏l-test</title>
    <style>
        body{font-family:system-ui;margin:16px}
        .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
        input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
        label{display:block;font-weight:600;margin-top:10px}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{border-bottom:1px solid #eee;padding:8px 4px;text-align:left}
        .right{text-align:right}
        .muted{color:#666;font-size:13px}
        .row{display:flex;gap:10px;flex-wrap:wrap}
        .row>*{flex:1;min-width:160px}
    </style>
</head>
<body>
<h1>Jule√∏l-test üçª</h1>

<div id="screenSetup" class="card">
    <h2>Start</h2>

    <label for="olsSelect">Velg √∏lsmaking</label>
    <select id="olsSelect">
        <option value="">Laster‚Ä¶</option>
    </select>
    <div class="muted" id="olsInfo">‚Äî</div>

    <label for="name">Navn</label>
    <input id="name" placeholder="Skriv navnet ditt" autocomplete="name" />

    <button id="start" style="margin-top:12px;">Start</button>
    <p class="muted">N√•r du har startet l√•ses √∏lsmakingen, s√• du ikke kan bytte underveis.</p>
</div>

<div id="screenRate" class="card" style="display:none">
    <div class="muted">√òlsmaking: <b id="olsTitle">‚Äî</b></div>
    <div class="muted">Du: <b id="who">‚Äî</b></div>

    <label>Velg √∏l-nummer</label>
    <select id="beerSelect">
        <option value="">Velg‚Ä¶</option>
    </select>
    <div class="muted" id="beerHelp"></div>

    <label>Smak (0‚Äì50)</label>
    <input id="smak" type="number" min="0" max="50" step="1" inputmode="numeric" />

    <label>Ettersmak (0‚Äì20)</label>
    <input id="ettersmak" type="number" min="0" max="20" step="1" inputmode="numeric" />

    <label>Farge (0‚Äì20)</label>
    <input id="farge" type="number" min="0" max="20" step="1" inputmode="numeric" />

    <label>Lukt (0‚Äì10)</label>
    <input id="lukt" type="number" min="0" max="10" step="1" inputmode="numeric" />

    <div class="muted" id="totalPreview" style="margin-top:10px">Total: 0 / 100</div>

    <div class="row" style="margin-top:12px">
        <button id="save">Lagre / oppdater</button>
        <button id="reset" type="button">Bytt navn / √∏lsmaking</button>
    </div>

    <div class="muted" id="status" style="margin-top:8px">‚Äî</div>

    <div class="card">
        <h3>Dine registreringer</h3>
        <table>
            <thead><tr><th>√òl #</th><th class="right">Total</th></tr></thead>
            <tbody id="rows"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // LocalStorage keys
    const LS_NAME = "juleol_name_v2";
    const LS_OLSM = "juleol_ols_id_v2";       // √∏lsmaking id
    const LS_STARTED = "juleol_started_v2";   // "1" n√•r man har startet

    // UI
    const screenSetup = document.querySelector("#screenSetup");
    const screenRate = document.querySelector("#screenRate");

    const olsSelect = document.querySelector("#olsSelect");
    const olsInfo = document.querySelector("#olsInfo");

    const nameInput = document.querySelector("#name");
    const startBtn = document.querySelector("#start");

    const olsTitle = document.querySelector("#olsTitle");
    const who = document.querySelector("#who");

    const beerSelect = document.querySelector("#beerSelect");
    const beerHelp = document.querySelector("#beerHelp");

    const smakEl = document.querySelector("#smak");
    const ettersmakEl = document.querySelector("#ettersmak");
    const fargeEl = document.querySelector("#farge");
    const luktEl = document.querySelector("#lukt");
    const totalPreview = document.querySelector("#totalPreview");

    const rows = document.querySelector("#rows");
    const status = document.querySelector("#status");

    let sessionUserId = null;
    let currentOlsId = null;
    let totalBeers = 0;
    let currentOlsTitle = "";

    function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m]));
    }

    function clampInt(v, min, max) {
        const n = Number(v);
        if (!Number.isFinite(n)) return null;
        const i = Math.trunc(n);
        if (i < min || i > max) return null;
        return i;
    }

    function calcTotal100() {
        const smak = clampInt(smakEl.value, 0, 50) ?? 0;
        const ettersmak = clampInt(ettersmakEl.value, 0, 20) ?? 0;
        const farge = clampInt(fargeEl.value, 0, 20) ?? 0;
        const lukt = clampInt(luktEl.value, 0, 10) ?? 0;
        const total = smak + ettersmak + farge + lukt;
        totalPreview.textContent = `Total: ${total} / 100`;
        return total;
    }
    [smakEl, ettersmakEl, fargeEl, luktEl].forEach(el => el.addEventListener("input", calcTotal100));

    async function ensureSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
            sessionUserId = session.user.id;
            return session;
        }
        const { data, error } = await supabase.auth.signInAnonymously();
        if (error) throw error;
        sessionUserId = data.session.user.id;
        return data.session;
    }

    async function loadOlsList() {
        const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, revealed, created_at")
            .order("created_at", { ascending: false });

        if (error) throw error;

        olsSelect.innerHTML =
            `<option value="">Velg‚Ä¶</option>` +
            (data ?? []).map(o => `<option value="${o.id}">${escapeHtml(o.title)} (${o.total_beers || 0} √∏l)</option>`).join("");
    }

    async function loadOlsMeta(olsId) {
        const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, revealed")
            .eq("id", olsId)
            .single();

        if (error) throw error;

        currentOlsTitle = data.title ?? "";
        totalBeers = Number(data.total_beers || 0);

        olsInfo.textContent = `${data.title} ‚Äî N=${totalBeers} ‚Äî ${data.revealed ? "REVEALED" : "skjult"}`;

        if (!totalBeers || totalBeers <= 0) {
            beerSelect.innerHTML = `<option value="">Admin har ikke satt N enn√•</option>`;
            beerHelp.textContent = "Be admin sette antall √∏l (N).";
            return;
        }

        const opts = [`<option value="">Velg‚Ä¶</option>`];
        for (let i = 1; i <= totalBeers; i++) opts.push(`<option value="${i}">√òl #${i}</option>`);
        beerSelect.innerHTML = opts.join("");
        beerHelp.textContent = `${totalBeers} √∏l i √∏lsmakingen.`;
    }

    async function loadMyRatings() {
        const { data, error } = await supabase
            .from("ratings")
            .select("beer_no, score")
            .eq("tasting_id", currentOlsId)
            .eq("user_id", sessionUserId)
            .order("beer_no", { ascending: true });

        if (error) throw error;

        rows.innerHTML = "";
        for (const r of (data ?? [])) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${r.beer_no}</td><td class="right">${r.score}</td>`;
            rows.appendChild(tr);
        }
    }

    function lockSetupUI() {
        olsSelect.disabled = true;
        nameInput.disabled = true;
        startBtn.disabled = true;
    }

    function unlockSetupUI() {
        olsSelect.disabled = false;
        nameInput.disabled = false;
        startBtn.disabled = false;
    }

    function goToRateScreen() {
        screenSetup.style.display = "none";
        screenRate.style.display = "block";
        olsTitle.textContent = currentOlsTitle || "‚Äî";
        who.textContent = localStorage.getItem(LS_NAME) || "‚Äî";
        calcTotal100();
    }

    function goToSetupScreen() {
        screenRate.style.display = "none";
        screenSetup.style.display = "block";
        unlockSetupUI();
    }

    olsSelect.addEventListener("change", async () => {
        // Ikke tillat bytte hvis startet
        if (localStorage.getItem(LS_STARTED) === "1") {
            olsSelect.value = currentOlsId || "";
            return;
        }

        const id = olsSelect.value || "";
        localStorage.setItem(LS_OLSM, id);

        if (!id) {
            currentOlsId = null;
            olsInfo.textContent = "Velg √∏lsmaking‚Ä¶";
            beerSelect.innerHTML = `<option value="">Velg √∏lsmaking f√∏rst‚Ä¶</option>`;
            return;
        }

        currentOlsId = id;
        await loadOlsMeta(id);
    });

    startBtn.addEventListener("click", async () => {
        const name = nameInput.value.trim();
        const olsId = olsSelect.value;

        if (!olsId) return alert("Velg √∏lsmaking f√∏rst üôÇ");
        if (!name) return alert("Skriv inn navn f√∏rst üôÇ");

        localStorage.setItem(LS_NAME, name);
        localStorage.setItem(LS_OLSM, olsId);
        localStorage.setItem(LS_STARTED, "1");

        currentOlsId = olsId;
        await loadOlsMeta(olsId);

        lockSetupUI();
        goToRateScreen();
        await loadMyRatings();
    });

    document.querySelector("#reset").addEventListener("click", () => {
        // ‚ÄúHard reset‚Äù for √• kunne velge ny √∏lsmaking
        localStorage.removeItem(LS_NAME);
        localStorage.removeItem(LS_OLSM);
        localStorage.removeItem(LS_STARTED);
        location.reload();
    });

    document.querySelector("#save").addEventListener("click", async () => {
        const name = localStorage.getItem(LS_NAME);
        if (!name) return alert("Mangler navn");
        if (!currentOlsId) return alert("Mangler √∏lsmaking");

        const beerNo = clampInt(beerSelect.value, 1, totalBeers || 9999);
        if (beerNo === null) return alert("Velg √∏l-nummer");

        const smak = clampInt(smakEl.value, 0, 50);
        const ettersmak = clampInt(ettersmakEl.value, 0, 20);
        const farge = clampInt(fargeEl.value, 0, 20);
        const lukt = clampInt(luktEl.value, 0, 10);

        if (smak === null) return alert("Smak m√• v√¶re 0‚Äì50");
        if (ettersmak === null) return alert("Ettersmak m√• v√¶re 0‚Äì20");
        if (farge === null) return alert("Farge m√• v√¶re 0‚Äì20");
        if (lukt === null) return alert("Lukt m√• v√¶re 0‚Äì10");

        const total = smak + ettersmak + farge + lukt;
        status.textContent = "Lagrer‚Ä¶";

        const payload = {
            tasting_id: currentOlsId,
            beer_no: beerNo,
            user_id: sessionUserId,              // ‚úÖ viktig
            display_name: name,
            smak, ettersmak, farge, lukt,
            score: total
        };

        const { error } = await supabase
            .from("ratings")
            .upsert(payload, { onConflict: "tasting_id,beer_no,user_id" }); // ‚úÖ oppdater uten constraint-feil

        if (error) return alert("Feil ved lagring: " + error.message);

        status.textContent = "Lagret/oppdatert: " + new Date().toLocaleTimeString();
        await loadMyRatings();
    });

    async function boot() {
        await ensureSession();
        await loadOlsList();

        // hvis man allerede har startet f√∏r (refresh)
        const started = localStorage.getItem(LS_STARTED) === "1";
        const savedOls = localStorage.getItem(LS_OLSM) || "";
        const savedName = localStorage.getItem(LS_NAME) || "";

        if (savedOls) {
            olsSelect.value = savedOls;
            currentOlsId = savedOls;
            await loadOlsMeta(savedOls);
        } else {
            olsInfo.textContent = "Velg √∏lsmaking‚Ä¶";
        }

        if (savedName) nameInput.value = savedName;

        if (started && savedOls && savedName) {
            lockSetupUI();
            goToRateScreen();
            await loadMyRatings();
        } else {
            goToSetupScreen();
        }

        calcTotal100();
    }

    boot().catch(e => alert("Oppstart-feil: " + e.message));
</script>
</body>
</html>
