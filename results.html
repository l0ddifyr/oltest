<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultater ‚Äì Jule√∏l</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    label{display:block;font-weight:600;margin-top:10px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1;min-width:160px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left;vertical-align:top}
    .right{text-align:right}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    details summary{cursor:pointer;font-weight:600}
    pre{white-space:pre-wrap;word-break:break-word;border:1px solid #eee;padding:10px;border-radius:10px;margin-top:10px}
    .errorBox{border:1px solid #f3c2c2;background:#fff5f5;border-radius:12px;padding:12px}
  </style>
</head>
<body>
<h1>Resultater üç∫</h1>

<!-- FATAL/BOOT STATUS -->
<div id="bootMsg" class="card muted">Laster‚Ä¶</div>

<!-- LOGIN (skjules n√•r innlogget) -->
<div id="loginCard" class="card" style="display:none">
  <h2>Logg inn</h2>
  <div class="row">
    <input id="email" placeholder="E-post" autocomplete="email" />
    <input id="pass" placeholder="Passord" type="password" autocomplete="current-password" />
  </div>
  <button id="login" type="button" style="margin-top:10px">Logg inn</button>
  <div class="muted" id="loginStatus">‚Äî</div>
</div>

<!-- APP (skjules f√∏r innlogging) -->
<div id="resultsApp" style="display:none">
  <div class="card">
    <div class="row">
      <h2 style="flex:2">Velg √∏lsmaking</h2>
      <button id="logout" type="button" style="flex:1">Logg ut</button>
    </div>

    <select id="olsSelect">
      <option value="">Laster‚Ä¶</option>
    </select>

    <div class="row" style="margin-top:10px">
      <button id="load" type="button">Last resultater</button>
      <button id="refreshList" type="button">Oppdater liste</button>
    </div>

    <div class="muted" id="loadStatus">‚Äî</div>
  </div>

  <div id="content" style="display:none">
    <div class="card">
      <h2>Status</h2>
      <div class="row">
        <div><span class="pill" id="revealPill">‚Äî</span></div>
        <div class="muted" id="metaText">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <h2>Ranking per √∏l</h2>
      <table>
        <thead>
        <tr>
          <th>√òl #</th>
          <th>Navn</th>
          <th class="right">Snitt</th>
          <th class="right">#</th>
          <th class="right">Best</th>
          <th class="right">Worst</th>
        </tr>
        </thead>
        <tbody id="rankingRows"></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Alle stemmer (hvem ga hva)</h2>

      <div class="row">
        <div>
          <label>Filter: √òl</label>
          <select id="filterBeer"><option value="">Alle</option></select>
        </div>
        <div>
          <label>Filter: Person</label>
          <select id="filterPerson"><option value="">Alle</option></select>
        </div>
        <div>
          <label>Sorter</label>
          <select id="sortBy">
            <option value="beer_no">√òlnr</option>
            <option value="score_desc">Score (h√∏y‚Üílav)</option>
            <option value="score_asc">Score (lav‚Üíh√∏y)</option>
            <option value="name">Navn</option>
            <option value="time_desc">Tid (ny‚Üígammel)</option>
            <option value="time_asc">Tid (gammel‚Üíny)</option>
          </select>
        </div>
      </div>

      <table>
        <thead>
        <tr>
          <th>√òl #</th>
          <th>Navn</th>
          <th>Person</th>
          <th class="right">Total</th>
          <th class="right">Smak</th>
          <th class="right">Etter</th>
          <th class="right">Farge</th>
          <th class="right">Lukt</th>
          <th class="right">Tid</th>
        </tr>
        </thead>
        <tbody id="votesRows"></tbody>
      </table>

      <details style="margin-top:12px">
        <summary>Eksporter CSV (kopier)</summary>
        <button id="copyCsv" type="button" style="margin-top:10px">Kopier CSV</button>
        <pre id="csvOut"></pre>
      </details>
    </div>
  </div>
</div>

<script type="module">
  const bootMsg = document.querySelector("#bootMsg");

  function fatal(msg, extra="") {
    bootMsg.classList.remove("muted");
    bootMsg.innerHTML = `
        <div class="errorBox">
          <b>Kunne ikke starte results.html</b><br/>
          ${msg}<br/>
          <div class="muted" style="margin-top:8px">${extra}</div>
        </div>
      `;
  }

  // 1) Last config.js robust
  let cfg;
  try {
    cfg = await import("./config.js");
  } catch (e) {
    fatal(
            "Finner ikke ./config.js (eller den kan ikke lastes).",
            "Sjekk at config.js ligger i samme mappe som results.html, og at du √•pner siden via http(s) (GitHub Pages / lokal server) ‚Äì ikke file://."
    );
    console.error("config.js import failed", e);
    throw e;
  }

  // 2) Last supabase-js robust
  let createClient;
  try {
    ({ createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"));
  } catch (e) {
    fatal(
            "Klarte ikke laste supabase-js fra CDN.",
            "Sjekk nett/annonsesperre (adblock) eller pr√∏v et annet nett."
    );
    console.error("supabase-js import failed", e);
    throw e;
  }

  // 3) App
  const supabase = createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);

  const loginCard = document.querySelector("#loginCard");
  const resultsApp = document.querySelector("#resultsApp");
  const loginStatus = document.querySelector("#loginStatus");
  const loadStatus = document.querySelector("#loadStatus");

  const olsSelect = document.querySelector("#olsSelect");
  const content = document.querySelector("#content");

  const revealPill = document.querySelector("#revealPill");
  const metaText = document.querySelector("#metaText");

  const rankingRows = document.querySelector("#rankingRows");
  const votesRows = document.querySelector("#votesRows");

  const filterBeer = document.querySelector("#filterBeer");
  const filterPerson = document.querySelector("#filterPerson");
  const sortBy = document.querySelector("#sortBy");

  const csvOut = document.querySelector("#csvOut");

  let beersMap = new Map();
  let votes = [];
  let ranking = [];

  function showLogin() {
    bootMsg.style.display = "none";
    loginCard.style.display = "block";
    resultsApp.style.display = "none";
    content.style.display = "none";
  }

  function showApp() {
    bootMsg.style.display = "none";
    loginCard.style.display = "none";
    resultsApp.style.display = "block";
  }

  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) throw new Error("Du m√• logge inn.");
    return session;
  }

  function fmtTime(iso) {
    if (!iso) return "";
    return new Date(iso).toLocaleString();
  }

  function csvEscape(v) {
    const s = (v ?? "").toString();
    if (s.includes(",") || s.includes("\"") || s.includes("\n")) return `"${s.replaceAll("\"","\"\"")}"`;
    return s;
  }

  async function loadMyOlsmakinger() {
    const session = await requireAuth();
    const uid = session.user.id;

    const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, created_at, created_by")
            .eq("created_by", uid)
            .order("created_at", { ascending: false });

    if (error) throw error;

    olsSelect.innerHTML =
            `<option value="">Velg‚Ä¶</option>` +
            (data ?? []).map(o => `<option value="${o.id}">${o.title} (N=${o.total_beers || 0})</option>`).join("");

    loadStatus.textContent = (data?.length ?? 0) ? "Velg en √∏lsmaking og trykk ‚ÄúLast resultater‚Äù." : "Ingen √∏lsmakinger p√• denne admin-brukeren.";
  }

  async function loadMeta(olsId) {
    const { data, error } = await supabase
            .from("tastings")
            .select("title, total_beers, revealed, join_code, current_beer_no")
            .eq("id", olsId)
            .single();

    if (error) throw error;

    revealPill.textContent = data.revealed ? "REVEALED ‚úÖ" : "SKJULT üîí";
    metaText.textContent = `${data.title} ‚Äî N=${data.total_beers} ‚Äî Join-kode: ${data.join_code ?? "‚Äî"} ‚Äî N√•: √òl #${data.current_beer_no ?? 1}`;
  }

  async function loadBeersPublic(olsId) {
    const { data, error } = await supabase
            .from("beers_public")
            .select("beer_no, name")
            .eq("tasting_id", olsId)
            .order("beer_no", { ascending: true });

    if (error) throw error;
    beersMap = new Map((data ?? []).map(x => [x.beer_no, x.name]));
  }

  async function loadAllVotes(olsId) {
    const { data, error } = await supabase
            .from("ratings")
            .select("beer_no, score, smak, ettersmak, farge, lukt, display_name, updated_at, created_at")
            .eq("tasting_id", olsId);

    if (error) throw error;
    votes = (data ?? []).map(v => ({ ...v, time: v.updated_at ?? v.created_at }));
  }

  function buildRanking() {
    const byBeer = new Map();
    for (const v of votes) {
      if (!byBeer.has(v.beer_no)) byBeer.set(v.beer_no, { beer_no: v.beer_no, sum:0, count:0, min:Infinity, max:-Infinity });
      const a = byBeer.get(v.beer_no);
      a.sum += Number(v.score);
      a.count++;
      a.min = Math.min(a.min, Number(v.score));
      a.max = Math.max(a.max, Number(v.score));
    }
    ranking = [...byBeer.values()].map(r => ({
      beer_no: r.beer_no,
      avg: r.count ? r.sum / r.count : 0,
      count: r.count,
      min: isFinite(r.min) ? r.min : null,
      max: isFinite(r.max) ? r.max : null
    })).sort((a,b) => b.avg - a.avg);
  }

  function populateFilters() {
    const beerNos = [...new Set(votes.map(v => v.beer_no))].sort((a,b) => a-b);
    filterBeer.innerHTML = `<option value="">Alle</option>` + beerNos.map(n => `<option value="${n}">${n}</option>`).join("");

    const people = [...new Set(votes.map(v => v.display_name))].sort((a,b) => a.localeCompare(b));
    filterPerson.innerHTML = `<option value="">Alle</option>` + people.map(p => `<option value="${encodeURIComponent(p)}">${p}</option>`).join("");
  }

  function renderRanking() {
    rankingRows.innerHTML = "";
    for (const r of ranking) {
      const name = beersMap.get(r.beer_no) ?? null;
      const tr = document.createElement("tr");
      tr.innerHTML = `
          <td>${r.beer_no}</td>
          <td>${name ? name : "<span class='muted'>(skjult)</span>"}</td>
          <td class="right">${r.avg.toFixed(2)}</td>
          <td class="right">${r.count}</td>
          <td class="right">${r.max ?? ""}</td>
          <td class="right">${r.min ?? ""}</td>
        `;
      rankingRows.appendChild(tr);
    }
  }

  function getFilteredVotes() {
    let out = [...votes];

    const b = filterBeer.value;
    if (b) out = out.filter(v => String(v.beer_no) === String(b));

    const p = filterPerson.value;
    if (p) out = out.filter(v => v.display_name === decodeURIComponent(p));

    switch (sortBy.value) {
      case "beer_no": out.sort((a,b) => a.beer_no - b.beer_no); break;
      case "name": out.sort((a,b) => a.display_name.localeCompare(b.display_name)); break;
      case "score_desc": out.sort((a,b) => b.score - a.score); break;
      case "score_asc": out.sort((a,b) => a.score - b.score); break;
      case "time_desc": out.sort((a,b) => new Date(b.time) - new Date(a.time)); break;
      case "time_asc": out.sort((a,b) => new Date(a.time) - new Date(b.time)); break;
    }
    return out;
  }

  function buildCsv(list) {
    const header = ["beer_no","beer_name","person","score","smak","ettersmak","farge","lukt","time"];
    const lines = [header.join(",")];

    for (const v of list) {
      const beerName = beersMap.get(v.beer_no) ?? "";
      lines.push([
        v.beer_no, beerName, v.display_name, v.score, v.smak, v.ettersmak, v.farge, v.lukt, fmtTime(v.time)
      ].map(csvEscape).join(","));
    }
    csvOut.textContent = lines.join("\n");
  }

  function renderVotes() {
    const list = getFilteredVotes();
    votesRows.innerHTML = "";
    for (const v of list) {
      const beerName = beersMap.get(v.beer_no) ?? null;
      const tr = document.createElement("tr");
      tr.innerHTML = `
          <td>${v.beer_no}</td>
          <td>${beerName ? beerName : "<span class='muted'>(skjult)</span>"}</td>
          <td>${v.display_name}</td>
          <td class="right"><b>${v.score}</b></td>
          <td class="right">${v.smak}</td>
          <td class="right">${v.ettersmak}</td>
          <td class="right">${v.farge}</td>
          <td class="right">${v.lukt}</td>
          <td class="right">${fmtTime(v.time)}</td>
        `;
      votesRows.appendChild(tr);
    }
    buildCsv(list);
  }

  document.querySelector("#copyCsv").addEventListener("click", async () => {
    const txt = csvOut.textContent || "";
    if (!txt) return alert("Ingen CSV √• kopiere");
    await navigator.clipboard.writeText(txt);
    alert("CSV kopiert ‚úÖ");
  });

  [filterBeer, filterPerson, sortBy].forEach(el => el.addEventListener("change", renderVotes));

  // EVENTS: login/logout/load
  document.querySelector("#login").addEventListener("click", async () => {
    try {
      loginStatus.textContent = "Logger inn‚Ä¶";
      const email = document.querySelector("#email").value.trim();
      const pass = document.querySelector("#pass").value;

      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;

      showApp();
      await loadMyOlsmakinger();
      loginStatus.textContent = "‚Äî";
    } catch (e) {
      alert(e.message);
      loginStatus.textContent = "Feil ved innlogging";
    }
  });

  document.querySelector("#logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    showLogin();
  });

  document.querySelector("#refreshList").addEventListener("click", async () => {
    try {
      await requireAuth();
      await loadMyOlsmakinger();
      loadStatus.textContent = "Liste oppdatert ‚úÖ";
    } catch (e) {
      alert(e.message);
    }
  });

  document.querySelector("#load").addEventListener("click", async () => {
    try {
      await requireAuth();
      const id = olsSelect.value;
      if (!id) return alert("Velg √∏lsmaking");

      loadStatus.textContent = "Laster‚Ä¶";

      await loadMeta(id);
      await loadBeersPublic(id);
      await loadAllVotes(id);

      buildRanking();
      populateFilters();
      renderRanking();
      renderVotes();

      content.style.display = "block";
      loadStatus.textContent = `Lastet ‚úÖ (${votes.length} stemmer)`;
    } catch (e) {
      alert(e.message);
      loadStatus.textContent = "Feil";
    }
  });

  // INIT
  (async () => {
    // hvis du er logget inn fra f√∏r
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      showApp();
      await loadMyOlsmakinger();
    } else {
      showLogin();
    }
  })();
</script>
</body>
</html>
