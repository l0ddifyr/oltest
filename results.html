<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jule√∏l ‚Äì Resultater</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    label{display:block;font-weight:600;margin-top:10px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:140px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left;vertical-align:top}
    .right{text-align:right}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    .danger{border-color:#f0caca}
    .ok{border-color:#cfe8cf}
    details summary{cursor:pointer; font-weight:600}
    code{font-size:12px}
  </style>
</head>
<body>
<h1>Resultater üç∫</h1>

<div class="card">
  <h2>Admin-login</h2>
  <div class="row">
    <input id="email" placeholder="E-post" autocomplete="email" />
    <input id="pass" placeholder="Passord" type="password" autocomplete="current-password" />
  </div>
  <div class="row" style="margin-top:10px">
    <button id="login">Logg inn</button>
    <button id="logout" type="button">Logg ut</button>
  </div>
  <div class="muted" id="authStatus">‚Äî</div>
</div>

<div class="card">
  <h2>Velg tasting</h2>
  <label>Tasting ID (UUID)</label>
  <input id="tastingId" placeholder="Lim inn tasting UUID" />
  <div class="row" style="margin-top:10px">
    <button id="load">Last resultater</button>
    <button id="copyLink" type="button">Kopier ‚Äúdeltakerlink‚Äù</button>
  </div>
  <div class="muted" id="loadStatus">‚Äî</div>
  <div class="muted">
    ‚ÄúDeltakerlink‚Äù er bare en hjelpetekst for deg (index.html med samme TASTING_ID). Denne siden viser navn/poeng og b√∏r v√¶re admin-only.
  </div>
</div>

<div id="content" style="display:none">
  <div class="card">
    <h2>Status</h2>
    <div class="row">
      <div><span class="pill" id="revealPill">‚Äî</span></div>
      <div class="muted">√òlnavn kommer fra <code>beers_public</code> (null f√∏r reveal).</div>
    </div>
  </div>

  <div class="card">
    <h2>Ranking per √∏l</h2>
    <table>
      <thead>
      <tr>
        <th>√òl</th>
        <th>Navn</th>
        <th class="right">Snitt</th>
        <th class="right">#</th>
        <th class="right">Best</th>
        <th class="right">Worst</th>
      </tr>
      </thead>
      <tbody id="rankingRows"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Alle stemmer (hvem ga hva)</h2>

    <div class="row">
      <div>
        <label>Filter: √òl</label>
        <select id="filterBeer">
          <option value="">Alle</option>
        </select>
      </div>
      <div>
        <label>Filter: Person</label>
        <select id="filterPerson">
          <option value="">Alle</option>
        </select>
      </div>
      <div>
        <label>Sorter</label>
        <select id="sortBy">
          <option value="beer_no">√òlnr</option>
          <option value="score_desc">Score (h√∏y‚Üílav)</option>
          <option value="score_asc">Score (lav‚Üíh√∏y)</option>
          <option value="name">Navn</option>
          <option value="time_desc">Tid (ny‚Üígammel)</option>
          <option value="time_asc">Tid (gammel‚Üíny)</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
      <tr>
        <th>√òl</th>
        <th>Navn</th>
        <th>Person</th>
        <th class="right">Total</th>
        <th class="right">Smak</th>
        <th class="right">Etter</th>
        <th class="right">Farge</th>
        <th class="right">Lukt</th>
        <th class="right">Tid</th>
      </tr>
      </thead>
      <tbody id="votesRows"></tbody>
    </table>

    <details style="margin-top:12px">
      <summary>Eksporter CSV (kopier)</summary>
      <p class="muted">Klikk knappen og lim inn i Excel/Google Sheets.</p>
      <button id="copyCsv" type="button">Kopier CSV</button>
      <pre id="csvOut" style="white-space:pre-wrap; word-break:break-word; border:1px solid #eee; padding:10px; border-radius:10px; margin-top:10px;"></pre>
    </details>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://lgwgsbdqsrfjmbcqomns.supabase.co";
  const SUPABASE_ANON_KEY = "PASTE_ANON_KEY_HERE";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const authStatus = document.querySelector("#authStatus");
  const loadStatus = document.querySelector("#loadStatus");
  const content = document.querySelector("#content");

  const rankingRows = document.querySelector("#rankingRows");
  const votesRows = document.querySelector("#votesRows");

  const filterBeer = document.querySelector("#filterBeer");
  const filterPerson = document.querySelector("#filterPerson");
  const sortBy = document.querySelector("#sortBy");

  const revealPill = document.querySelector("#revealPill");

  const csvOut = document.querySelector("#csvOut");

  let beersMap = new Map();   // beer_no -> name|null
  let votes = [];            // ratings rows
  let ranking = [];          // aggregated per beer

  function fmtTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString();
  }

  function safe(s) {
    return (s ?? "").toString();
  }

  function csvEscape(v) {
    const s = safe(v);
    if (s.includes(",") || s.includes("\"") || s.includes("\n")) {
      return `"${s.replaceAll("\"","\"\"")}"`;
    }
    return s;
  }

  async function refreshAuthStatus() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      authStatus.textContent = "Innlogget ‚úÖ";
    } else {
      authStatus.textContent = "Ikke innlogget";
    }
    return session;
  }

  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) throw new Error("Du m√• logge inn som admin for √• se resultater.");
    return session;
  }

  document.querySelector("#login").addEventListener("click", async () => {
    try {
      const email = document.querySelector("#email").value.trim();
      const pass = document.querySelector("#pass").value;
      authStatus.textContent = "Logger inn‚Ä¶";
      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;
      await refreshAuthStatus();
    } catch (e) {
      console.error(e);
      alert(e.message);
      authStatus.textContent = "Feil";
    }
  });

  document.querySelector("#logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    await refreshAuthStatus();
    content.style.display = "none";
  });

  document.querySelector("#copyLink").addEventListener("click", async () => {
    const id = document.querySelector("#tastingId").value.trim();
    if (!id) return alert("Lim inn tasting ID f√∏rst");
    const hint = `Husk √• sette TASTING_ID = "${id}" i index.html f√∏r du deler deltakerlinken.`;
    await navigator.clipboard.writeText(hint);
    alert("Kopiert ‚úÖ");
  });

  async function loadTastingMeta(tastingId) {
    const { data, error } = await supabase
            .from("tastings")
            .select("id, revealed, title")
            .eq("id", tastingId)
            .single();

    if (error) throw error;

    revealPill.textContent = data.revealed ? "REVEALED ‚úÖ (√∏lnavn synlig)" : "SKJULT üîí (√∏lnavn = null)";
    revealPill.className = "pill " + (data.revealed ? "ok" : "danger");
  }

  async function loadBeersPublic(tastingId) {
    const { data, error } = await supabase
            .from("beers_public")
            .select("beer_no, name")
            .eq("tasting_id", tastingId)
            .order("beer_no", { ascending: true });

    if (error) throw error;

    beersMap = new Map(data.map(x => [x.beer_no, x.name])); // name kan v√¶re null f√∏r reveal
  }

  async function loadAllVotes(tastingId) {
    // NB: Dette krever at du er admin (policy ratings_admin_select_all_in_own_tasting)
    const { data, error } = await supabase
            .from("ratings")
            .select("beer_no, score, smak, ettersmak, farge, lukt, display_name, updated_at, created_at")
            .eq("tasting_id", tastingId);

    if (error) throw error;

    votes = data.map(v => ({
      ...v,
      time: v.updated_at ?? v.created_at
    }));
  }

  function buildRanking() {
    const byBeer = new Map(); // beer_no -> {sum, count, min, max}
    for (const v of votes) {
      const key = v.beer_no;
      if (!byBeer.has(key)) byBeer.set(key, { beer_no: key, sum: 0, count: 0, min: Infinity, max: -Infinity });
      const agg = byBeer.get(key);
      agg.sum += Number(v.score);
      agg.count += 1;
      agg.min = Math.min(agg.min, Number(v.score));
      agg.max = Math.max(agg.max, Number(v.score));
    }
    ranking = [...byBeer.values()].map(r => ({
      beer_no: r.beer_no,
      avg: r.count ? r.sum / r.count : 0,
      count: r.count,
      min: r.min === Infinity ? null : r.min,
      max: r.max === -Infinity ? null : r.max
    })).sort((a,b) => b.avg - a.avg);
  }

  function populateFilters() {
    // √òl-filter
    const beerNos = [...new Set(votes.map(v => v.beer_no))].sort((a,b) => a-b);
    filterBeer.innerHTML = `<option value="">Alle</option>` + beerNos.map(n => `<option value="${n}">${n}</option>`).join("");

    // Person-filter
    const people = [...new Set(votes.map(v => v.display_name))].sort((a,b) => a.localeCompare(b));
    filterPerson.innerHTML = `<option value="">Alle</option>` + people.map(p => `<option value="${encodeURIComponent(p)}">${p}</option>`).join("");
  }

  function renderRanking() {
    rankingRows.innerHTML = "";
    for (const r of ranking) {
      const name = beersMap.get(r.beer_no) ?? null;
      const tr = document.createElement("tr");
      tr.innerHTML = `
          <td>${r.beer_no}</td>
          <td>${name ? safe(name) : "<span class='muted'>(skjult)</span>"}</td>
          <td class="right">${r.avg.toFixed(2)}</td>
          <td class="right">${r.count}</td>
          <td class="right">${r.max ?? ""}</td>
          <td class="right">${r.min ?? ""}</td>
        `;
      rankingRows.appendChild(tr);
    }
  }

  function getFilteredVotes() {
    let out = [...votes];

    const beerVal = filterBeer.value;
    if (beerVal) out = out.filter(v => String(v.beer_no) === String(beerVal));

    const personVal = filterPerson.value;
    if (personVal) {
      const decoded = decodeURIComponent(personVal);
      out = out.filter(v => v.display_name === decoded);
    }

    const sortVal = sortBy.value;
    if (sortVal === "beer_no") out.sort((a,b) => a.beer_no - b.beer_no);
    if (sortVal === "name") out.sort((a,b) => a.display_name.localeCompare(b.display_name));
    if (sortVal === "score_desc") out.sort((a,b) => b.score - a.score);
    if (sortVal === "score_asc") out.sort((a,b) => a.score - b.score);
    if (sortVal === "time_desc") out.sort((a,b) => new Date(b.time) - new Date(a.time));
    if (sortVal === "time_asc") out.sort((a,b) => new Date(a.time) - new Date(b.time));

    return out;
  }

  function renderVotes() {
    const list = getFilteredVotes();
    votesRows.innerHTML = "";

    for (const v of list) {
      const beerName = beersMap.get(v.beer_no) ?? null;

      const tr = document.createElement("tr");
      tr.innerHTML = `
          <td>${v.beer_no}</td>
          <td>${beerName ? safe(beerName) : "<span class='muted'>(skjult)</span>"}</td>
          <td>${safe(v.display_name)}</td>
          <td class="right"><b>${v.score}</b></td>
          <td class="right">${v.smak}</td>
          <td class="right">${v.ettersmak}</td>
          <td class="right">${v.farge}</td>
          <td class="right">${v.lukt}</td>
          <td class="right">${fmtTime(v.time)}</td>
        `;
      votesRows.appendChild(tr);
    }

    buildCsv(list);
  }

  function buildCsv(list) {
    const header = ["beer_no","beer_name","person","score","smak","ettersmak","farge","lukt","time"];
    const lines = [header.join(",")];

    for (const v of list) {
      const beerName = beersMap.get(v.beer_no) ?? "";
      const row = [
        v.beer_no,
        beerName,
        v.display_name,
        v.score,
        v.smak,
        v.ettersmak,
        v.farge,
        v.lukt,
        fmtTime(v.time)
      ].map(csvEscape);

      lines.push(row.join(","));
    }

    csvOut.textContent = lines.join("\n");
  }

  document.querySelector("#copyCsv").addEventListener("click", async () => {
    const txt = csvOut.textContent || "";
    if (!txt) return alert("Ingen CSV √• kopiere");
    await navigator.clipboard.writeText(txt);
    alert("CSV kopiert ‚úÖ");
  });

  [filterBeer, filterPerson, sortBy].forEach(el => el.addEventListener("change", renderVotes));

  document.querySelector("#load").addEventListener("click", async () => {
    try {
      await requireAuth();

      const tastingId = document.querySelector("#tastingId").value.trim();
      if (!tastingId) return alert("Lim inn tasting ID");

      loadStatus.textContent = "Laster‚Ä¶";

      await loadTastingMeta(tastingId);
      await loadBeersPublic(tastingId);
      await loadAllVotes(tastingId);

      buildRanking();
      populateFilters();
      renderRanking();
      renderVotes();

      content.style.display = "block";
      loadStatus.textContent = `Lastet ‚úÖ (${votes.length} stemmer)`;
    } catch (e) {
      console.error(e);
      alert(e.message);
      loadStatus.textContent = "Feil";
    }
  });

  // initial
  refreshAuthStatus();
</script>
</body>
</html>
