<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultater ‚Äì Jule√∏l üç∫</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; background-color: #f8f9fa; color: #333; }
    .card { background: white; border: 1px solid #ddd; border-radius: 16px; padding: 20px; margin: 16px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    h1, h2 { color: #800000; text-align: center; }

    input, button, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    button { background: #d4a017; color: white; border: none; font-weight: 700; cursor: pointer; }
    button.secondary { background: #eee; color: #333; border: 1px solid #ddd; margin-top: 10px; }

    .chart-container { position: relative; height: 40vh; width: 100%; margin: 20px 0; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
    th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
    th { background: #f1f1f1; font-weight: 700; }
    .right { text-align: right; }

    .pill { display: inline-block; padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: bold; background: #eee; }
    .pill.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .muted { color: #666; font-size: 13px; text-align: center; }
  </style>
</head>
<body>

<h1>Resultater üçª</h1>

<div id="bootMsg" class="card muted">Laster systemet...</div>

<div id="loginCard" class="card" style="display:none">
  <h2>Admin Logg inn</h2>
  <input id="email" placeholder="E-post" autocomplete="email" style="margin-bottom:10px" />
  <input id="pass" placeholder="Passord" type="password" />
  <button id="login" style="margin-top:10px">Se resultater</button>
</div>

<div id="resultsApp" style="display:none">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
      <h3 style="margin:0">Velg test</h3>
      <button id="logout" class="secondary" style="width:auto; margin:0">Log ut</button>
    </div>
    <select id="olsSelect"><option value="">Laster √∏lsmakinger...</option></select>
    <button id="load" style="margin-top:10px">Oppdater Resultater üîÑ</button>
  </div>

  <div id="content" style="display:none">
    <div class="card">
      <h2>Toppliste</h2>
      <div class="chart-container">
        <canvas id="resultsChart"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>Ranking detaljer</h2>
      <div class="muted" id="metaStatus"></div>
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>√òl / Navn</th>
          <th class="right">Snitt</th>
          <th class="right">Stemmer</th>
        </tr>
        </thead>
        <tbody id="rankingRows"></tbody>
      </table>
    </div>

    <div class="card">
      <details>
        <summary style="cursor:pointer; font-weight:bold">Se alle enkeltstemmer</summary>
        <div class="grid" style="margin-top:15px">
          <select id="sortBy">
            <option value="score_desc">H√∏yest score</option>
            <option value="beer_no">√òlnummer</option>
            <option value="time_desc">Siste f√∏rst</option>
          </select>
        </div>
        <table style="font-size: 13px;">
          <thead>
          <tr>
            <th>√òl</th>
            <th>Person</th>
            <th class="right">Score</th>
          </tr>
          </thead>
          <tbody id="votesRows"></tbody>
        </table>
      </details>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let myChart = null;
  let beersMap = new Map();
  let votes = [];
  let isRevealed = false;

  const resultsApp = document.querySelector("#resultsApp"), loginCard = document.querySelector("#loginCard");
  const olsSelect = document.querySelector("#olsSelect"), content = document.querySelector("#content");
  const rankingRows = document.querySelector("#rankingRows"), votesRows = document.querySelector("#votesRows");

  // AUTH
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      showApp();
      loadTastings();
    } else {
      showLogin();
    }
  }

  function showLogin() {
    loginCard.style.display = "block";
    resultsApp.style.display = "none";
    document.querySelector("#bootMsg").style.display = "none";
  }

  function showApp() {
    resultsApp.style.display = "block";
    loginCard.style.display = "none";
    document.querySelector("#bootMsg").style.display = "none";
  }

  document.querySelector("#login").onclick = async () => {
    const { error } = await supabase.auth.signInWithPassword({
      email: document.querySelector("#email").value,
      password: document.querySelector("#pass").value
    });
    if (error) alert(error.message); else checkAuth();
  };

  document.querySelector("#logout").onclick = async () => { await supabase.auth.signOut(); location.reload(); };

  // DATA LASTING
  async function loadTastings() {
    const { data } = await supabase.from("tastings").select("*").order("created_at", { ascending: false });
    olsSelect.innerHTML = `<option value="">Velg √∏lsmaking...</option>` +
            data.map(o => `<option value="${o.id}">${o.title}</option>`).join("");
  }

  async function loadAllData() {
    const id = olsSelect.value;
    if (!id) return;

    // 1. Last Meta & Reveal status
    const { data: meta } = await supabase.from("tastings").select("*").eq("id", id).single();
    isRevealed = meta.revealed;
    document.querySelector("#metaStatus").innerHTML = `Status: ${isRevealed ? "<span class='pill success'>REVEALED ‚úÖ</span>" : "<span class='pill'>SKJULT üîí</span>"}`;

    // 2. Last √òlnavn (beers_public er en view som tar hensyn til revealed)
    const { data: beers } = await supabase.from("beers_public").select("*").eq("tasting_id", id);
    beersMap = new Map(beers.map(b => [b.beer_no, b.name]));

    // 3. Last Stemmer
    const { data: r } = await supabase.from("ratings").select("*").eq("tasting_id", id);
    votes = r;

    processAndRender();
  }

  function processAndRender() {
    const beerStats = {};
    votes.forEach(v => {
      if (!beerStats[v.beer_no]) beerStats[v.beer_no] = { beer_no: v.beer_no, sum: 0, count: 0 };
      beerStats[v.beer_no].sum += v.score;
      beerStats[v.beer_no].count++;
    });

    const ranking = Object.values(beerStats).map(b => ({
      ...b,
      avg: b.sum / b.count,
      name: beersMap.get(b.beer_no) || `√òl #${b.beer_no}`
    })).sort((a, b) => b.avg - a.avg);

    renderChart(ranking);
    renderTable(ranking);
    renderAllVotes();
    content.style.display = "block";
  }

  function renderChart(ranking) {
    const ctx = document.getElementById('resultsChart').getContext('2d');
    if (myChart) myChart.destroy();

    myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ranking.map(r => r.name),
        datasets: [{
          label: 'Gjennomsnittsscore',
          data: ranking.map(r => r.avg.toFixed(1)),
          backgroundColor: '#d4a017',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });
  }

  function renderTable(ranking) {
    rankingRows.innerHTML = ranking.map(r => `
      <tr>
        <td><b>${r.beer_no}</b></td>
        <td>${r.name}</td>
        <td class="right"><b>${r.avg.toFixed(1)}</b></td>
        <td class="right muted">${r.count} stk</td>
      </tr>
    `).join("");
  }

  function renderAllVotes() {
    let sortedVotes = [...votes];
    const sortVal = document.querySelector("#sortBy").value;

    if(sortVal === "score_desc") sortedVotes.sort((a,b) => b.score - a.score);
    if(sortVal === "beer_no") sortedVotes.sort((a,b) => a.beer_no - b.beer_no);
    if(sortVal === "time_desc") sortedVotes.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

    votesRows.innerHTML = sortedVotes.map(v => `
      <tr>
        <td>√òl ${v.beer_no}</td>
        <td>${v.display_name}</td>
        <td class="right">${v.score}</td>
      </tr>
    `).join("");
  }

  document.querySelector("#load").onclick = loadAllData;
  document.querySelector("#sortBy").onchange = renderAllVotes;
  olsSelect.onchange = loadAllData;

  checkAuth();
</script>
</body>
</html>