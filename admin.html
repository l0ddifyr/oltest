<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jule√∏l admin</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    label{display:block;font-weight:600;margin-top:10px}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 4px;text-align:left}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:160px}
  </style>
</head>
<body>
<h1>Admin üç∫</h1>

<div class="card">
  <h2>Login</h2>
  <div class="row">
    <input id="email" placeholder="E-post" autocomplete="email" />
    <input id="pass" placeholder="Passord" type="password" autocomplete="current-password" />
  </div>
  <div class="row" style="margin-top:10px">
    <button id="login">Logg inn</button>
    <button id="logout" type="button">Logg ut</button>
  </div>
  <div class="muted" id="loginStatus">‚Äî</div>
</div>

<div class="card">
  <h2>Velg / opprett tasting</h2>

  <label>Eksisterende tastings</label>
  <select id="tastingSelect">
    <option value="">‚Äî</option>
  </select>

  <div class="row">
    <div>
      <label>Tittel</label>
      <input id="title" placeholder="Jule√∏l-test" />
    </div>
    <div>
      <label>Antall √∏l (N)</label>
      <input id="totalBeers" inputmode="numeric" placeholder="10" />
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="createTasting" type="button">Opprett ny</button>
    <button id="saveMeta" type="button">Lagre tittel/N</button>
    <button id="loadBeers" type="button">Last √∏lliste</button>
  </div>

  <div class="muted" id="tastingStatus">‚Äî</div>
</div>

<div class="card">
  <h2>Logg √∏l underveis (skjult for andre)</h2>

  <div class="row">
    <div>
      <label>√òl-nummer</label>
      <input id="beerNo" inputmode="numeric" placeholder="3" />
    </div>
    <div>
      <label>√òlnavn</label>
      <input id="beerName" placeholder="Mack Jule√∏l" />
    </div>
  </div>

  <button id="saveBeer" type="button" style="margin-top:10px">Lagre / oppdater mapping</button>

  <table>
    <thead><tr><th>#</th><th>Navn</th></tr></thead>
    <tbody id="beerRows"></tbody>
  </table>
</div>

<div class="card">
  <h2>Reveal</h2>
  <button id="reveal" type="button">Reveal (revealed=true)</button>
  <div class="muted">Etter reveal vil <code>beers_public</code> vise navn.</div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const loginStatus = document.querySelector("#loginStatus");
  const tastingStatus = document.querySelector("#tastingStatus");

  const tastingSelect = document.querySelector("#tastingSelect");
  const titleEl = document.querySelector("#title");
  const totalBeersEl = document.querySelector("#totalBeers");

  const beerRows = document.querySelector("#beerRows");

  let currentTastingId = null;

  function clampInt(v, min, max) {
    const n = Number(v);
    if (!Number.isFinite(n)) return null;
    const i = Math.trunc(n);
    if (i < min || i > max) return null;
    return i;
  }

  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) throw new Error("Ikke logget inn");
    return session;
  }

  async function loadMyTastings() {
    await requireAuth();

    const { data: { session } } = await supabase.auth.getSession();

    const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, revealed, created_at, created_by")
            .eq("created_by", session.user.id)
            .order("created_at", { ascending: false });

    if (error) throw error;

    tastingSelect.innerHTML =
            `<option value="">Velg‚Ä¶</option>` +
            (data ?? []).map(t => `<option value="${t.id}">${t.title} (N=${t.total_beers || 0})</option>`).join("");
  }

  async function loadTastingMeta(id) {
    const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, revealed")
            .eq("id", id)
            .single();
    if (error) throw error;
    titleEl.value = data.title ?? "";
    totalBeersEl.value = data.total_beers ?? 0;
    tastingStatus.textContent = `Valgt: ${data.title} ‚Äî N=${data.total_beers} ‚Äî ${data.revealed ? "REVEALED" : "skjult"}`;
  }

  async function refreshBeers() {
    if (!currentTastingId) return;
    const { data, error } = await supabase
            .from("beers")
            .select("beer_no, name")
            .eq("tasting_id", currentTastingId)
            .order("beer_no", { ascending: true });

    if (error) throw error;

    beerRows.innerHTML = "";
    for (const b of (data ?? [])) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${b.beer_no}</td><td>${b.name}</td>`;
      beerRows.appendChild(tr);
    }
  }

  document.querySelector("#login").addEventListener("click", async () => {
    const email = document.querySelector("#email").value.trim();
    const pass = document.querySelector("#pass").value;
    loginStatus.textContent = "Logger inn‚Ä¶";
    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) return alert(error.message);
    loginStatus.textContent = "Innlogget ‚úÖ";
    await loadMyTastings();
  });

  document.querySelector("#logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    loginStatus.textContent = "Logget ut";
    tastingSelect.innerHTML = `<option value="">‚Äî</option>`;
    currentTastingId = null;
  });

  tastingSelect.addEventListener("change", async () => {
    const id = tastingSelect.value || null;
    currentTastingId = id;
    if (!id) return;
    await loadTastingMeta(id);
    await refreshBeers();
  });

  document.querySelector("#createTasting").addEventListener("click", async () => {
    await requireAuth();
    const title = (titleEl.value || "Jule√∏l-test").trim();
    const n = clampInt(totalBeersEl.value, 1, 200);
    if (n === null) return alert("N m√• v√¶re 1‚Äì200");

    const { data, error } = await supabase
            .from("tastings")
            .insert({ title, revealed: false, total_beers: n })
            .select("id")
            .single();

    if (error) return alert(error.message);

    tastingStatus.textContent = "Opprettet ‚úÖ";
    await loadMyTastings();
    tastingSelect.value = data.id;
    currentTastingId = data.id;
    await loadTastingMeta(data.id);
    await refreshBeers();
  });

  document.querySelector("#saveMeta").addEventListener("click", async () => {
    await requireAuth();
    if (!currentTastingId) return alert("Velg tasting f√∏rst");
    const title = (titleEl.value || "Jule√∏l-test").trim();
    const n = clampInt(totalBeersEl.value, 1, 200);
    if (n === null) return alert("N m√• v√¶re 1‚Äì200");

    const { error } = await supabase
            .from("tastings")
            .update({ title, total_beers: n })
            .eq("id", currentTastingId);

    if (error) return alert(error.message);
    tastingStatus.textContent = "Oppdatert ‚úÖ";
    await loadMyTastings();
  });

  document.querySelector("#loadBeers").addEventListener("click", async () => {
    await requireAuth();
    await refreshBeers();
  });

  document.querySelector("#saveBeer").addEventListener("click", async () => {
    await requireAuth();
    if (!currentTastingId) return alert("Velg tasting f√∏rst");

    const beerNo = clampInt(document.querySelector("#beerNo").value, 1, 9999);
    const beerName = document.querySelector("#beerName").value.trim();
    if (beerNo === null) return alert("Ugyldig √∏lnummer");
    if (!beerName) return alert("Mangler √∏lnavn");

    const { error } = await supabase
            .from("beers")
            .upsert({ tasting_id: currentTastingId, beer_no: beerNo, name: beerName });

    if (error) return alert(error.message);

    document.querySelector("#beerName").value = "";
    await refreshBeers();
  });

  document.querySelector("#reveal").addEventListener("click", async () => {
    await requireAuth();
    if (!currentTastingId) return alert("Velg tasting f√∏rst");
    if (!confirm("Reveal n√•? Etter dette blir √∏lnavn synlig i results.")) return;

    const { error } = await supabase
            .from("tastings")
            .update({ revealed: true })
            .eq("id", currentTastingId);

    if (error) return alert(error.message);
    alert("Reveal ‚úÖ");
    await loadTastingMeta(currentTastingId);
  });

  // Start: bare vis liste hvis allerede innlogget
  (async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        loginStatus.textContent = "Innlogget ‚úÖ";
        await loadMyTastings();
      } else {
        loginStatus.textContent = "Ikke innlogget";
      }
    } catch {}
  })();
</script>
</body>
</html>
