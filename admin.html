<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Jule√∏l-test üç∫</title>
  <style>
    body{font-family:system-ui, -apple-system, sans-serif; margin:16px; background-color: #f4f4f4; color: #333;}
    .card{background: white; border: 1px solid #ddd; border-radius: 16px; padding: 20px; margin: 16px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
    input, button, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    button { background: #d4a017; color: white; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
    button:active { transform: scale(0.98); }
    button.secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    label{ display: block; font-weight: 600; margin-top: 15px; margin-bottom: 5px; }
    .muted{ color: #666; font-size: 13px; }
    .row{ display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1; min-width: 120px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
    .pill { display: inline-block; padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: bold; background: #eee; margin: 2px; }
    .pill.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .pill.info { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
    #currentBeerText { font-size: 28px; font-weight: 900; color: #800000; margin: 10px 0; }
    .hidden { display: none !important; }
    .header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  </style>
</head>
<body>

<h1>Admin üç∫</h1>

<div id="sectionLogin" class="card">
  <h2>Logg inn</h2>
  <input id="email" placeholder="E-post" style="margin-bottom:10px" />
  <input id="pass" placeholder="Passord" type="password" />
  <button id="login">Logg inn</button>
</div>

<div id="sectionPicker" class="card hidden">
  <div class="header-info">
    <h2>Dine √∏lsmakinger</h2>
    <button id="logout1" class="secondary" style="width:auto; margin:0; padding: 8px 12px;">Logg ut</button>
  </div>

  <label>Velg eksisterende</label>
  <select id="olsSelect"><option value="">Laster...</option></select>

  <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">

  <h3>Opprett ny test</h3>
  <input id="title" placeholder="Navn p√• testen (f.eks. Jule√∏l 2025)" style="margin-bottom:10px" />
  <input id="totalBeers" type="number" placeholder="Antall √∏l (f.eks. 10)" />
  <button id="createOls">Start ny √∏lsmaking</button>
</div>

<div id="sectionControl" class="hidden">

  <div class="card" style="text-align: center; border: 2px solid #d4a017;">
    <div class="header-info" style="justify-content: center; gap: 10px;">
      <span class="pill info" id="displayJoinCode">KODE: ‚Äî</span>
      <button id="backToPicker" class="secondary" style="width:auto; margin:0; padding: 4px 10px; font-size: 12px;">Bytt test</button>
    </div>

    <div class="muted" id="displayTitle">Laster...</div>
    <div id="currentBeerText">√òl #‚Äî</div>

    <div class="row">
      <button id="prevBeer" class="secondary">‚óÄ Forrige</button>
      <button id="nextBeer">Neste √∏l ‚ñ∂</button>
    </div>
  </div>

  <div class="card">
    <div class="header-info">
      <h3 style="margin:0">Deltakere</h3>
      <span class="pill" id="totalVotersCount">0 p√•meldte</span>
    </div>
    <div class="muted">Alle i rommet:</div>
    <div id="allParticipants" style="margin-bottom:15px; padding: 10px 0;">‚Äî</div>

    <div class="muted">Har stemt p√• √òl #<span id="progressBeerNo">‚Äî</span>:</div>
    <div id="voterList" style="min-height: 40px;">‚Äî</div>
  </div>

  <div class="card">
    <details>
      <summary style="cursor:pointer; font-weight:600;">Fasit & Avansert</summary>
      <div class="row" style="margin-top:15px">
        <input id="beerNo" type="number" placeholder="Nr" style="flex:0.3" />
        <input id="beerName" placeholder="Navn p√• √∏l" style="flex:1" />
        <button id="saveBeer" style="margin:0; flex:0.5">Lagre</button>
      </div>
      <table>
        <tbody id="beerRows"></tbody>
      </table>

      <button id="reveal" style="background: #2e7d32; margin-top:20px;">üîì Reveal for alle</button>
      <div style="text-align:center; margin-top:10px;"><span class="pill" id="revealPill">Status: Skjult</span></div>
    </details>
  </div>

</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Seksjoner
  const sLogin = document.getElementById("sectionLogin"), sPicker = document.getElementById("sectionPicker"), sControl = document.getElementById("sectionControl");

  // Elementer
  const olsSelect = document.getElementById("olsSelect"), currentBeerText = document.getElementById("currentBeerText");
  const displayJoinCode = document.getElementById("displayJoinCode"), displayTitle = document.getElementById("displayTitle");
  const voterList = document.getElementById("voterList"), allParticipants = document.getElementById("allParticipants");

  let currentOlsId = null, currentBeerNo = 1;

  // VISNINGS-LOGIKK
  function showStep(step) {
    sLogin.classList.toggle("hidden", step !== "login");
    sPicker.classList.toggle("hidden", step !== "picker");
    sControl.classList.toggle("hidden", step !== "control");
  }

  // AUTH
  async function checkSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      showStep("picker");
      loadTastings();
    } else {
      showStep("login");
    }
  }

  document.getElementById("login").onclick = async () => {
    const { error } = await supabase.auth.signInWithPassword({
      email: document.getElementById("email").value,
      password: document.getElementById("pass").value
    });
    if (error) alert(error.message); else checkSession();
  };

  document.querySelectorAll("[id^='logout']").forEach(btn => btn.onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  });

  // DATA LASTING
  async function loadTastings() {
    const { data: { user } } = await supabase.auth.getUser();
    const { data } = await supabase.from("tastings").select("*").eq("created_by", user.id).order("created_at", { ascending: false });
    olsSelect.innerHTML = `<option value="">Velg en √∏lsmaking...</option>` +
            data.map(o => `<option value="${o.id}">${o.title}</option>`).join("");
  }

  async function selectTasting(id) {
    if(!id) return;
    const { data, error } = await supabase.from("tastings").select("*").eq("id", id).single();
    if(error) return;

    currentOlsId = id;
    currentBeerNo = data.current_beer_no || 1;
    displayTitle.textContent = data.title;
    displayJoinCode.textContent = `KODE: ${data.join_code}`;
    currentBeerText.textContent = `√òl #${currentBeerNo} / ${data.total_beers}`;
    document.getElementById("revealPill").textContent = data.revealed ? "Status: REVEALED ‚úÖ" : "Status: SKJULT üîí";

    showStep("control");
    updateVoterProgress();
    refreshBeers();
  }

  olsSelect.onchange = (e) => selectTasting(e.target.value);
  document.getElementById("backToPicker").onclick = () => showStep("picker");

  // KONTROLL-FUNKSJONER
  async function changeBeer(delta) {
    const nextNo = Math.max(1, currentBeerNo + delta);
    const { error } = await supabase.from("tastings").update({ current_beer_no: nextNo }).eq("id", currentOlsId);
    if (!error) {
      currentBeerNo = nextNo;
      currentBeerText.textContent = `√òl #${currentBeerNo} / ${document.getElementById("totalBeers").value || '?'}`;
      updateVoterProgress();
    }
  }

  document.getElementById("nextBeer").onclick = () => changeBeer(1);
  document.getElementById("prevBeer").onclick = () => changeBeer(-1);

  // DELTAKERE PROGRESS (Samme logikk som vi diskuterte)
  async function updateVoterProgress() {
    if (!currentOlsId || sControl.classList.contains("hidden")) return;
    const { data: ratings } = await supabase.from("ratings").select("display_name, beer_no").eq("tasting_id", currentOlsId);

    const participants = [...new Set(ratings.map(r => r.display_name))];
    document.getElementById("totalVotersCount").textContent = `${participants.length} p√•meldte`;
    allParticipants.innerHTML = participants.map(p => `<span class="pill">${p}</span>`).join("");

    const votedNow = ratings.filter(r => r.beer_no === currentBeerNo).map(r => r.display_name);
    voterList.innerHTML = votedNow.length ? votedNow.map(v => `<span class="pill success">${v} ‚úÖ</span>`).join("") : `<span class="muted">Venter...</span>`;
    document.getElementById("progressBeerNo").textContent = currentBeerNo;
  }

  // REVEAL OG FASIT
  document.getElementById("saveBeer").onclick = async () => {
    const no = document.getElementById("beerNo").value, name = document.getElementById("beerName").value;
    await supabase.from("beers").upsert({ tasting_id: currentOlsId, beer_no: no, name: name }, { onConflict: "tasting_id,beer_no" });
    document.getElementById("beerName").value = ""; refreshBeers();
  };

  async function refreshBeers() {
    const { data } = await supabase.from("beers").select("*").eq("tasting_id", currentOlsId).order("beer_no");
    document.getElementById("beerRows").innerHTML = data.map(b => `<tr><td>${b.beer_no}</td><td>${b.name}</td></tr>`).join("");
  }

  document.getElementById("createOls").onclick = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    const { data, error } = await supabase.from("tastings").insert({
      title: document.getElementById("title").value,
      total_beers: document.getElementById("totalBeers").value
    }).select().single();
    if(error) alert(error.message); else selectTasting(data.id);
  };

  document.getElementById("reveal").onclick = async () => {
    if(confirm("Vis fasiten for alle?")) {
      await supabase.from("tastings").update({ revealed: true }).eq("id", currentOlsId);
      selectTasting(currentOlsId);
    }
  };

  setInterval(updateVoterProgress, 5000);
  checkSession();
</script>
</body>
</html>