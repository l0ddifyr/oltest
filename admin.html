<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Jule√∏l-test üç∫</title>
  <style>
    body{font-family:system-ui, -apple-system, sans-serif; margin:16px; background-color: #f4f4f4; color: #333;}
    .card{background: white; border: 1px solid #ddd; border-radius: 16px; padding: 20px; margin: 16px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
    input, button, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    button { background: #d4a017; color: white; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
    button:active { transform: scale(0.98); }
    button.secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    button.danger { background: #ff4d4d; color: white; padding: 6px 12px; font-size: 12px; width: auto; margin: 0; }
    label{ display: block; font-weight: 600; margin-top: 15px; margin-bottom: 5px; }
    .muted{ color: #666; font-size: 13px; }
    .row{ display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1; min-width: 120px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
    .pill { display: inline-block; padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: bold; background: #eee; margin: 2px; }
    .pill.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .pill.info { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
    #currentBeerText { font-size: 32px; font-weight: 900; color: #800000; margin: 10px 0; }
    .hidden { display: none !important; }
    hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
  </style>
</head>
<body>

<h1>Admin üç∫</h1>

<div id="sectionLogin" class="card">
  <h2>Logg inn</h2>
  <input id="email" placeholder="E-post" style="margin-bottom:10px" />
  <input id="pass" placeholder="Passord" type="password" />
  <button id="loginBtn">Logg inn</button>
</div>

<div id="sectionPicker" class="card hidden">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>Dine √∏lsmakinger</h2>
    <button id="logoutBtn" class="secondary" style="width:auto; margin:0; padding: 8px 12px;">Logg ut</button>
  </div>

  <label>Velg eksisterende</label>
  <select id="olsSelect"><option value="">Laster...</option></select>

  <hr>

  <h3>Opprett ny test</h3>
  <input id="title" placeholder="Navn (f.eks. Jule√∏l 2025)" style="margin-bottom:10px" />
  <input id="totalBeers" type="number" placeholder="Antall √∏l totalt" />
  <button id="createOlsBtn">Start ny √∏lsmaking</button>
</div>

<div id="sectionControl" class="hidden">

  <div class="card" style="text-align: center; border: 2px solid #d4a017;">
    <div style="display:flex; justify-content: space-between; align-items: center;">
      <button id="backToPicker" class="secondary" style="width:auto; margin:0; padding: 6px 12px; font-size: 12px;">‚óÄ Bytt test</button>
      <span class="pill info" id="displayJoinCode">KODE: ‚Äî</span>
    </div>

    <div class="muted" id="displayTitle" style="margin-top:10px">...</div>
    <div id="currentBeerText">√òl #1</div>

    <div class="row">
      <button id="prevBeerBtn" class="secondary">‚óÄ Forrige</button>
      <button id="nextBeerBtn">Neste √∏l ‚ñ∂</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h3 style="margin:0">Status deltakere</h3>
      <span class="pill" id="totalVotersCount">0 p√•meldte</span>
    </div>
    <div class="muted">Alle i rommet:</div>
    <div id="allParticipants" style="padding: 10px 0; border-bottom: 1px solid #f9f9f9; margin-bottom: 10px;">‚Äî</div>

    <div class="muted">Har stemt p√• <b>√òl #<span id="progressBeerNo">1</span></b>:</div>
    <div id="voterList" style="min-height: 30px; padding: 10px 0;">‚Äî</div>
  </div>

  <div class="card">
    <details>
      <summary style="cursor:pointer; font-weight:600; padding: 5px;">üç∫ Fasit & √òlliste (Etterarbeid)</summary>

      <div style="margin-top:15px; background: #f9f9f9; padding: 15px; border-radius: 12px;">
        <label>1. Legg til √∏l i poolen (f√∏r/under test)</label>
        <div class="row">
          <input id="newBeerName" placeholder="√òlnavn..." style="flex:2" />
          <button id="addBeerToPoolBtn" style="margin:0; flex:1">Legg til</button>
        </div>
      </div>

      <div style="margin-top:15px; background: #fff9eb; padding: 15px; border-radius: 12px;">
        <label>2. Koble navn til nummer (etter test)</label>
        <div class="row">
          <select id="beerPoolSelect" style="flex:2"><option>Laster...</option></select>
          <input id="assignBeerNo" type="number" placeholder="Nr" style="flex:0.5" />
          <button id="saveToFasitBtn" style="margin:0; flex:1">Lagre</button>
        </div>
      </div>

      <table>
        <thead><tr><th>#</th><th>√òl</th><th></th></tr></thead>
        <tbody id="beerRows"></tbody>
      </table>

      <hr>
      <button id="revealBtn" style="background: #2e7d32;">üîì Reveal Resultater for alle</button>
      <div style="text-align:center; margin-top:10px;"><span id="revealStatusPill" class="pill">Status: Skjult</span></div>
    </details>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentOlsId = null;
  let currentBeerNo = 1;

  // Navigasjon mellom steg
  function showStep(step) {
    document.getElementById("sectionLogin").classList.toggle("hidden", step !== "login");
    document.getElementById("sectionPicker").classList.toggle("hidden", step !== "picker");
    document.getElementById("sectionControl").classList.toggle("hidden", step !== "control");
  }

  // Auth funksjoner
  async function checkSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) { showStep("picker"); loadTastings(); } else { showStep("login"); }
  }

  document.getElementById("loginBtn").onclick = async () => {
    const { error } = await supabase.auth.signInWithPassword({
      email: document.getElementById("email").value,
      password: document.getElementById("pass").value
    });
    if (error) alert("Feil: " + error.message); else checkSession();
  };

  document.getElementById("logoutBtn").onclick = async () => { await supabase.auth.signOut(); location.reload(); };

  // Last tester
  async function loadTastings() {
    const { data: { user } } = await supabase.auth.getUser();
    const { data } = await supabase.from("tastings").select("*").eq("created_by", user.id).order("created_at", { ascending: false });
    document.getElementById("olsSelect").innerHTML = `<option value="">Velg √∏lsmaking...</option>` +
            data.map(o => `<option value="${o.id}">${o.title}</option>`).join("");
  }

  // Velg en test
  async function selectTasting(id) {
    if(!id) return;
    const { data, error } = await supabase.from("tastings").select("*").eq("id", id).single();
    if(error) return;

    currentOlsId = id;
    currentBeerNo = data.current_beer_no || 1;
    document.getElementById("displayTitle").textContent = data.title;
    document.getElementById("displayJoinCode").textContent = `KODE: ${data.join_code}`;
    updateControlUI(data);
    showStep("control");
    updateVoterProgress();
    refreshBeers();
  }

  function updateControlUI(data) {
    document.getElementById("currentBeerText").textContent = `√òl #${currentBeerNo}`;
    document.getElementById("progressBeerNo").textContent = currentBeerNo;
    const pill = document.getElementById("revealStatusPill");
    pill.textContent = data.revealed ? "Status: REVEALED ‚úÖ" : "Status: SKJULT üîí";
    pill.className = data.revealed ? "pill success" : "pill";
  }

  document.getElementById("olsSelect").onchange = (e) => selectTasting(e.target.value);
  document.getElementById("backToPicker").onclick = () => { currentOlsId = null; showStep("picker"); };

  // Styring av nummer
  async function changeBeer(delta) {
    const nextNo = Math.max(1, currentBeerNo + delta);
    const { error } = await supabase.from("tastings").update({ current_beer_no: nextNo }).eq("id", currentOlsId);
    if (!error) {
      currentBeerNo = nextNo;
      document.getElementById("currentBeerText").textContent = `√òl #${currentBeerNo}`;
      document.getElementById("progressBeerNo").textContent = currentBeerNo;
      updateVoterProgress();
    }
  }

  document.getElementById("nextBeerBtn").onclick = () => changeBeer(1);
  document.getElementById("prevBeerBtn").onclick = () => changeBeer(-1);

  // Deltakeroversikt
  async function updateVoterProgress() {
    if (!currentOlsId || document.getElementById("sectionControl").classList.contains("hidden")) return;
    const { data: ratings } = await supabase.from("ratings").select("display_name, beer_no").eq("tasting_id", currentOlsId);

    const participants = [...new Set(ratings.map(r => r.display_name))];
    document.getElementById("totalVotersCount").textContent = `${participants.length} p√•meldte`;
    document.getElementById("allParticipants").innerHTML = participants.map(p => `<span class="pill">${p}</span>`).join("");

    const votedNow = ratings.filter(r => r.beer_no === currentBeerNo).map(r => r.display_name);
    document.getElementById("voterList").innerHTML = votedNow.length ? votedNow.map(v => `<span class="pill success">${v} ‚úÖ</span>`).join("") : `<span class="muted">Ingen har stemt enn√•...</span>`;
  }

  // FASIT-LOGIKK
  document.getElementById("addBeerToPoolBtn").onclick = async () => {
    const name = document.getElementById("newBeerName").value.trim();
    if(!name) return;

    // Bruker et midlertidig h√∏yt nummer (f.eks 999) for √• passere CHECK > 0
    // Vi legger til et tilfeldig tall i tillegg s√• du kan ha flere i poolen samtidig
    const tempNo = 500 + Math.floor(Math.random() * 499);

    const { error } = await supabase.from("beers").insert({
      tasting_id: currentOlsId,
      name: name,
      beer_no: tempNo
    });

    if(error) {
      alert("Feil: " + error.message);
    } else {
      document.getElementById("newBeerName").value = "";
      refreshBeers();
    }
  };

  document.getElementById("saveToFasitBtn").onclick = async () => {
    const name = document.getElementById("beerPoolSelect").value;
    const no = parseInt(document.getElementById("assignBeerNo").value);
    if(!name || !no) return alert("Velg √∏l og nummer");

    // 1. Lagre det nye nummeret
    const { error } = await supabase.from("beers").upsert({
      tasting_id: currentOlsId,
      beer_no: no,
      name: name
    }, { onConflict: "tasting_id,beer_no" });

    if(!error) {
      // 2. Slett alle versjoner av dette √∏let som har et nummer > 499 (rydding i poolen)
      await supabase.from("beers")
              .delete()
              .eq("tasting_id", currentOlsId)
              .eq("name", name)
              .gt("beer_no", 499);

      document.getElementById("assignBeerNo").value = "";
      refreshBeers();
    } else {
      alert("Feil ved lagring: " + error.message);
    }
  };
  
  async function refreshBeers() {
    const { data } = await supabase.from("beers")
            .select("*")
            .eq("tasting_id", currentOlsId)
            .order("beer_no");

    // Kun vis √∏l med "ekte" numre (1-499) i tabellen
    const fasit = data.filter(b => b.beer_no > 0 && b.beer_no <= 499);
    document.getElementById("beerRows").innerHTML = fasit.map(b => `
    <tr>
      <td><b>${b.beer_no}</b></td>
      <td>${b.name}</td>
      <td style="text-align:right"><button class="danger" onclick="deleteBeer('${b.id}')">Slett</button></td>
    </tr>
  `).join("");

    // Vis ALLE i dropdown, men merk de som er i poolen (500+)
    document.getElementById("beerPoolSelect").innerHTML = `<option value="">Velg fra pool...</option>` +
            data.map(b => `<option value="${b.name}">${b.name} ${b.beer_no > 499 ? '(i pool)' : '(#'+b.beer_no+')'}</option>`).join("");
  }

  window.deleteBeer = async (id) => {
    if(confirm("Slette dette √∏let fra listen?")) {
      await supabase.from("beers").delete().eq("id", id);
      refreshBeers();
    }
  };

  // Opprett ny
  document.getElementById("createOlsBtn").onclick = async () => {
    const title = document.getElementById("title").value;
    const n = document.getElementById("totalBeers").value;
    if(!title || !n) return alert("Fyll inn navn og antall");
    const { data, error } = await supabase.from("tastings").insert({ title: title, total_beers: n }).select().single();
    if(!error) selectTasting(data.id); else alert(error.message);
  };

  document.getElementById("revealBtn").onclick = async () => {
    if(confirm("Vil du avsl√∏re alle √∏lnavnene for deltakerne n√•?")) {
      await supabase.from("tastings").update({ revealed: true }).eq("id", currentOlsId);
      const { data } = await supabase.from("tastings").select("*").eq("id", currentOlsId).single();
      updateControlUI(data);
    }
  };

  setInterval(updateVoterProgress, 5000);
  checkSession();
</script>
</body>
</html>