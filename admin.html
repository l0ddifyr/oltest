<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jule√∏l admin</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    label{display:block;font-weight:600;margin-top:10px}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 4px;text-align:left}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    code{font-size:12px}
  </style>
</head>
<body>
<h1>Admin üç∫</h1>

<div class="card">
  <h2>Login</h2>
  <input id="email" placeholder="E-post" autocomplete="email" />
  <input id="pass" placeholder="Passord" type="password" autocomplete="current-password" />
  <button id="login">Logg inn</button>
  <div class="muted" id="loginStatus">‚Äî</div>
</div>

<div class="card">
  <h2>Tasting</h2>
  <button id="createTasting">Opprett ny tasting</button>

  <label>Tasting ID (UUID)</label>
  <input id="tastingId" placeholder="Limes inn her (eller bruk knappen over)" />

  <div class="row" style="margin-top:10px">
    <button id="loadTasting" type="button">Last √∏l-liste</button>
    <button id="copyTasting" type="button">Kopier ID</button>
  </div>

  <div class="muted" id="tastingStatus">‚Äî</div>
  <div class="muted">Denne ID-en skal inn i <code>index.html</code> som <code>TASTING_ID</code>.</div>
</div>

<div class="card">
  <h2>√òl-mapping (skjult f√∏r reveal)</h2>

  <label>√òlnummer</label>
  <input id="beerNo" inputmode="numeric" placeholder="1" />

  <label>√òlnavn</label>
  <input id="beerName" placeholder="F.eks. N√∏gne √ò ‚Äì God Jul" />

  <button id="saveBeer" type="button" style="margin-top:10px">Lagre / oppdater</button>

  <table>
    <thead><tr><th>Nr</th><th>Navn</th></tr></thead>
    <tbody id="beerRows"></tbody>
  </table>
</div>

<div class="card">
  <h2>Reveal</h2>
  <button id="reveal" type="button">Reveal √∏lnavn (revealed=true)</button>
  <div class="muted">N√•r reveala er gjort, vil klienter kunne lese navn via <code>beers_public</code>.</div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // ‚úÖ Sett inn anon key under
  const SUPABASE_URL = "https://lgwgsbdqsrfjmbcqomns.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxnd2dzYmRxc3Jmam1iY3FvbW5zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MDMyMTEsImV4cCI6MjA4MTQ3OTIxMX0.nIGnmGVcgN_A4Vw-uDxszOzgoCAhAcS2WLR0VFERKts";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const loginStatus = document.querySelector("#loginStatus");
  const tastingStatus = document.querySelector("#tastingStatus");
  const tastingIdInput = document.querySelector("#tastingId");
  const beerRows = document.querySelector("#beerRows");

  function clampInt(v, min, max) {
    const n = Number(v);
    if (!Number.isFinite(n)) return null;
    const i = Math.trunc(n);
    if (i < min || i > max) return null;
    return i;
  }

  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("Ikke logget inn");
    return session;
  }

  async function refreshBeers() {
    const tastingId = tastingIdInput.value.trim();
    if (!tastingId) return;

    const { data, error } = await supabase
            .from("beers")
            .select("beer_no, name")
            .eq("tasting_id", tastingId)
            .order("beer_no", { ascending: true });

    if (error) throw error;

    beerRows.innerHTML = "";
    for (const b of data) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${b.beer_no}</td><td>${b.name}</td>`;
      beerRows.appendChild(tr);
    }
  }

  document.querySelector("#login").addEventListener("click", async () => {
    const email = document.querySelector("#email").value.trim();
    const pass = document.querySelector("#pass").value;

    loginStatus.textContent = "Logger inn‚Ä¶";
    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });

    if (error) {
      console.error(error);
      loginStatus.textContent = "Feil";
      return alert(error.message);
    }

    loginStatus.textContent = "Innlogget ‚úÖ";
  });

  document.querySelector("#createTasting").addEventListener("click", async () => {
    await requireAuth();
    tastingStatus.textContent = "Oppretter‚Ä¶";

    const { data, error } = await supabase
            .from("tastings")
            .insert({ title: "Jule√∏l-test", revealed: false })
            .select("id")
            .single();

    if (error) return alert(error.message);

    tastingIdInput.value = data.id;
    tastingStatus.textContent = "Opprettet: " + data.id;
    await refreshBeers();
  });

  document.querySelector("#loadTasting").addEventListener("click", async () => {
    await requireAuth();
    tastingStatus.textContent = "Laster‚Ä¶";
    await refreshBeers();
    tastingStatus.textContent = "Lastet ‚úÖ";
  });

  document.querySelector("#copyTasting").addEventListener("click", async () => {
    const id = tastingIdInput.value.trim();
    if (!id) return alert("Ingen tasting ID √• kopiere");
    await navigator.clipboard.writeText(id);
    alert("Kopiert ‚úÖ");
  });

  document.querySelector("#saveBeer").addEventListener("click", async () => {
    await requireAuth();

    const tastingId = tastingIdInput.value.trim();
    const beerNo = clampInt(document.querySelector("#beerNo").value, 1, 9999);
    const beerName = document.querySelector("#beerName").value.trim();

    if (!tastingId) return alert("Mangler tasting ID");
    if (beerNo === null) return alert("Ugyldig √∏lnummer");
    if (!beerName) return alert("Mangler √∏lnavn");

    const { error } = await supabase.from("beers").upsert({
      tasting_id: tastingId,
      beer_no: beerNo,
      name: beerName
    });

    if (error) return alert(error.message);

    document.querySelector("#beerName").value = "";
    await refreshBeers();
  });

  document.querySelector("#reveal").addEventListener("click", async () => {
    await requireAuth();

    const tastingId = tastingIdInput.value.trim();
    if (!tastingId) return alert("Mangler tasting ID");

    if (!confirm("Er du sikker? Etter reveal vil √∏lnavn bli synlig via beers_public.")) return;

    const { error } = await supabase
            .from("tastings")
            .update({ revealed: true })
            .eq("id", tastingId);

    if (error) return alert(error.message);

    alert("Reveal ‚úÖ");
  });
</script>
</body>
</html>
