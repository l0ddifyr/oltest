<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Jule√∏l-test üç∫</title>
  <style>
    body{font-family:system-ui, -apple-system, sans-serif; margin:16px; background-color: #f4f4f4; color: #333;}
    .card{background: white; border: 1px solid #ddd; border-radius: 16px; padding: 20px; margin: 16px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
    input, button, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    button { background: #d4a017; color: white; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
    button:active { transform: scale(0.98); }
    button.secondary { background: #eee; color: #333; border: 1px solid #ddd; }
    label{ display: block; font-weight: 600; margin-top: 15px; margin-bottom: 5px; }
    .muted{ color: #666; font-size: 13px; }
    .row{ display: flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 140px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
    .pill { display: inline-block; padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: bold; background: #eee; margin: 2px; }
    .pill.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    #currentBeerText { font-size: 24px; font-weight: 900; color: #800000; }
  </style>
</head>
<body>

<h1>Admin-panel üç∫</h1>

<div id="loginCard" class="card">
  <h2>Logg inn</h2>
  <input id="email" placeholder="E-post" autocomplete="email" style="margin-bottom:10px" />
  <input id="pass" placeholder="Passord" type="password" autocomplete="current-password" />
  <button id="login">Logg inn</button>
  <div class="muted" id="loginStatus" style="margin-top:10px; text-align:center;">‚Äî</div>
</div>

<div id="adminApp" style="display:none">

  <div class="card" style="text-align: center; border: 2px solid #d4a017;">
    <div class="muted">N√Ö SMAKES:</div>
    <div id="currentBeerText">√òl #‚Äî</div>
    <div class="row" style="margin-top:15px">
      <button id="prevBeer" class="secondary">‚óÄ Forrige</button>
      <button id="nextBeer">Neste √∏l ‚ñ∂</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3>Deltakere status</h3>
      <div class="pill" id="totalVotersCount">0 p√•meldte</div>
    </div>

    <div class="muted" style="margin-bottom:10px">Alle som deltar:</div>
    <div id="allParticipants" style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
      <span class="muted">Ingen deltakere funnet enn√•...</span>
    </div>

    <div class="muted" style="margin-bottom:10px">Har stemt p√• √òl #<span id="progressBeerNo">‚Äî</span>:</div>
    <div id="voterList" style="min-height: 40px;">
      <span class="muted">Ingen stemmer p√• dette √∏let enn√•...</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <h2 style="margin:0">√òlsmaking</h2>
      <button id="logout" class="secondary" style="margin:0; width: auto; padding: 8px 15px;">Logg ut</button>
    </div>

    <label>Velg √∏lsmaking</label>
    <select id="olsSelect"><option value="">Laster...</option></select>

    <div class="card" style="margin-top:20px; background: #fff9eb;">
      <div class="muted">Join-kode til deltakerne:</div>
      <div class="row" style="align-items: center;">
        <div style="font-size:32px; font-weight:900; letter-spacing:4px; color: #d4a017;" id="joinCodeText">‚Äî</div>
        <div style="display:flex; flex-direction: column; gap: 5px;">
          <button id="copyJoin" class="secondary" style="padding: 5px;">Kopier</button>
          <button id="regenJoin" class="secondary" style="padding: 5px; font-size: 10px;">Ny kode</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tittel</label>
        <input id="title" placeholder="F.eks. Jule√∏l 2024" />
      </div>
      <div>
        <label>Antall √∏l (N)</label>
        <input id="totalBeers" type="number" placeholder="10" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="createOls" class="secondary">Opprett ny</button>
      <button id="saveMeta">Lagre endringer</button>
    </div>
    <div class="muted" id="olsStatus" style="margin-top:10px; text-align:center;">‚Äî</div>
  </div>

  <div class="card">
    <h3>Fasit (hvilket √∏l er hva?)</h3>
    <div class="muted" style="margin-bottom:10px">Deltakerne ser ikke dette f√∏r du trykker "Reveal".</div>

    <div class="row">
      <input id="beerNo" type="number" placeholder="Nr" style="flex:0.3" />
      <input id="beerName" placeholder="Navn p√• √∏l" style="flex:1" />
      <button id="saveBeer" style="flex:0.5; margin:0">Lagre</button>
    </div>

    <table>
      <thead><tr><th>#</th><th>Navn p√• √∏l</th></tr></thead>
      <tbody id="beerRows"></tbody>
    </table>
  </div>

  <div class="card" style="text-align:center">
    <button id="reveal" style="background: #2e7d32;">üîì Reveal Resultater</button>
    <div style="margin-top:10px"><span class="pill" id="revealPill">Status: Skjult</span></div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const loginCard = document.querySelector("#loginCard"), adminApp = document.querySelector("#adminApp");
  const olsSelect = document.querySelector("#olsSelect"), titleEl = document.querySelector("#title");
  const totalBeersEl = document.querySelector("#totalBeers"), olsStatus = document.querySelector("#olsStatus");
  const beerRows = document.querySelector("#beerRows"), revealPill = document.querySelector("#revealPill");
  const currentBeerText = document.querySelector("#currentBeerText"), voterList = document.querySelector("#voterList");

  let currentOlsId = null, currentBeerNo = 1;

  // HJELPEFUNKSJONER
  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) throw new Error("Ikke innlogget");
    return session;
  }

  // LAST DATA
  async function loadMyOlsmakinger() {
    const session = await requireAuth();
    const { data, error } = await supabase.from("tastings").select("*").eq("created_by", session.user.id).order("created_at", { ascending: false });
    if (error) throw error;
    olsSelect.innerHTML = `<option value="">Velg en √∏lsmaking...</option>` +
            data.map(o => `<option value="${o.id}">${o.title} (${o.total_beers} √∏l)</option>`).join("");
  }

  async function loadOlsMeta(id) {
    const { data, error } = await supabase.from("tastings").select("*").eq("id", id).single();
    if (error) throw error;
    currentOlsId = id;
    currentBeerNo = data.current_beer_no || 1;
    titleEl.value = data.title;
    totalBeersEl.value = data.total_beers;
    currentBeerText.textContent = `√òl #${currentBeerNo} / ${data.total_beers}`;
    document.querySelector("#joinCodeText").textContent = data.join_code || "‚Äî";
    revealPill.textContent = data.revealed ? "Status: REVEALED ‚úÖ" : "Status: SKJULT üîí";
    revealPill.className = data.revealed ? "pill success" : "pill";
    updateVoterProgress();
  }

  // SE HVEM SOM HAR STEMT
  async function updateVoterProgress() {
    if (!currentOlsId) return;

    // 1. Hent ALLE unike deltakere som har sendt inn minst √©n rating i denne testen
    const { data: allRatings, error: err1 } = await supabase
            .from("ratings")
            .select("display_name, user_id, beer_no")
            .eq("tasting_id", currentOlsId);

    if (err1) return;

    // Lag en unik liste over alle deltakere (bruker Set for √• fjerne duplikater)
    const participants = [...new Set(allRatings.map(r => r.display_name))];
    const totalCount = participants.length;

    // Oppdater teller
    document.querySelector("#totalVotersCount").textContent = `${totalCount} ${totalCount === 1 ? 'deltaker' : 'deltakere'} totalt`;
    document.querySelector("#progressBeerNo").textContent = currentBeerNo;

    // Vis alle deltakere i den √∏verste listen
    const allListEl = document.getElementById("allParticipants");
    allListEl.innerHTML = participants.map(p => `<span class="pill">${p}</span>`).join("");

    // 2. Finn ut hvem som har stemt p√• AKKURAT n√•v√¶rende √∏l
    const votedThisRound = allRatings
            .filter(r => r.beer_no === currentBeerNo)
            .map(r => r.display_name);

    const currentListEl = document.getElementById("voterList");
    if (votedThisRound.length === 0) {
      currentListEl.innerHTML = `<span class="muted">Venter p√• stemmer...</span>`;
    } else {
      currentListEl.innerHTML = votedThisRound.map(v =>
              `<span class="pill success">${v} ‚úÖ</span>`
      ).join("");
    }
  }

  // NAVIGATION
  async function changeBeer(delta) {
    if (!currentOlsId) return alert("Velg en √∏lsmaking f√∏rst");
    let nextNo = currentBeerNo + delta;
    if (nextNo < 1) nextNo = 1;
    const { error } = await supabase.from("tastings").update({ current_beer_no: nextNo }).eq("id", currentOlsId);
    if (error) alert(error.message);
    else loadOlsMeta(currentOlsId);
  }

  document.querySelector("#nextBeer").onclick = () => changeBeer(1);
  document.querySelector("#prevBeer").onclick = () => changeBeer(-1);

  // LOGIN / LOGOUT
  document.querySelector("#login").onclick = async () => {
    const email = document.querySelector("#email").value.trim();
    const pass = document.querySelector("#pass").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) alert(error.message); else location.reload();
  };

  document.querySelector("#logout").onclick = async () => { await supabase.auth.signOut(); location.reload(); };

  // EVENTS
  olsSelect.onchange = () => { if(olsSelect.value) { loadOlsMeta(olsSelect.value); refreshBeers(); } };

  document.querySelector("#saveMeta").onclick = async () => {
    const { error } = await supabase.from("tastings").update({ title: titleEl.value, total_beers: totalBeersEl.value }).eq("id", currentOlsId);
    if (error) alert(error.message); else olsStatus.textContent = "Lagret! ‚úÖ";
  };

  async function refreshBeers() {
    const { data } = await supabase.from("beers").select("*").eq("tasting_id", currentOlsId).order("beer_no");
    beerRows.innerHTML = data.map(b => `<tr><td>${b.beer_no}</td><td>${b.name}</td></tr>`).join("");
  }

  document.querySelector("#saveBeer").onclick = async () => {
    const no = document.querySelector("#beerNo").value;
    const name = document.querySelector("#beerName").value;
    const { error } = await supabase.from("beers").upsert({ tasting_id: currentOlsId, beer_no: no, name: name }, { onConflict: "tasting_id,beer_no" });
    if (error) alert(error.message); else { document.querySelector("#beerName").value = ""; refreshBeers(); }
  };

  document.querySelector("#reveal").onclick = async () => {
    if (confirm("Er du sikker? Dette vil vise alle navnene p√• √∏lene til deltakerne!")) {
      await supabase.from("tastings").update({ revealed: true }).eq("id", currentOlsId);
      loadOlsMeta(currentOlsId);
    }
  };

  document.querySelector("#copyJoin").onclick = () => {
    navigator.clipboard.writeText(document.querySelector("#joinCodeText").textContent);
    alert("Kopiert!");
  };

  // Polling for √• se stemmer i sanntid
  setInterval(updateVoterProgress, 5000);

  // INIT
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      adminApp.style.display = "block";
      loginCard.style.display = "none";
      loadMyOlsmakinger();
    }
  })();
</script>
</body>
</html>