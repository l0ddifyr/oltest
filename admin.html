<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Jule√∏l</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    input,button,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    label{display:block;font-weight:600;margin-top:10px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:160px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
  </style>
</head>
<body>
<h1>Admin üç∫</h1>

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h2>Logg inn</h2>
  <div class="row">
    <input id="email" placeholder="E-post" autocomplete="email" />
    <input id="pass" placeholder="Passord" type="password" autocomplete="current-password" />
  </div>
  <div class="row" style="margin-top:10px">
    <button id="login">Logg inn</button>
  </div>
  <div class="muted" id="loginStatus">‚Äî</div>
</div>



<!-- ADMIN APP -->
<div id="adminApp" style="display:none">
  <div class="card">
    <h2>Styr hvilket √∏l som smakes n√•</h2>
    <div class="row">
      <button id="prevBeer" type="button">Forrige √∏l</button>
      <button id="nextBeer" type="button">Neste √∏l</button>
    </div>
    <div class="muted">N√•v√¶rende: <b id="currentBeerText">‚Äî</b></div>
  </div>
  <div class="card">
    <div class="row">
      <h2 style="flex:1">√òlsmaking</h2>
      <button id="logout" type="button">Logg ut</button>
    </div>

    <label>Velg eksisterende</label>
    <select id="olsSelect">
      <option value="">Laster‚Ä¶</option>
    </select>

    <div class="row">
      <div>
        <label>Tittel</label>
        <input id="title" placeholder="Jule√∏l-test" />
      </div>
      <div>
        <label>Antall √∏l (N)</label>
        <input id="totalBeers" inputmode="numeric" placeholder="10" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="createOls" type="button">Opprett ny</button>
      <button id="saveMeta" type="button">Lagre</button>
      <button id="reloadOls" type="button">Oppdater liste</button>
    </div>

    <div class="muted" id="olsStatus">‚Äî</div>
  </div>

  <div class="card">
    <h2>Logg √∏l (skjult for deltakere)</h2>

    <div class="row">
      <div>
        <label>√òl-nummer</label>
        <input id="beerNo" inputmode="numeric" placeholder="3" />
      </div>
      <div>
        <label>√òlnavn</label>
        <input id="beerName" placeholder="Mack Jule√∏l" />
      </div>
    </div>

    <button id="saveBeer" type="button" style="margin-top:10px">
      Lagre / oppdater √∏l
    </button>

    <table>
      <thead><tr><th>#</th><th>Navn</th></tr></thead>
      <tbody id="beerRows"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Reveal</h2>
    <div class="row">
      <button id="reveal" type="button">Reveal √∏lsmaking</button>
      <span class="pill" id="revealPill">‚Äî</span>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const loginCard = document.querySelector("#loginCard");
  const adminApp = document.querySelector("#adminApp");
  const loginStatus = document.querySelector("#loginStatus");

  const olsSelect = document.querySelector("#olsSelect");
  const titleEl = document.querySelector("#title");
  const totalBeersEl = document.querySelector("#totalBeers");
  const olsStatus = document.querySelector("#olsStatus");
  const beerRows = document.querySelector("#beerRows");
  const revealPill = document.querySelector("#revealPill");

  let currentOlsId = null;

  function clampInt(v, min, max) {
    const n = Number(v);
    if (!Number.isFinite(n)) return null;
    const i = Math.trunc(n);
    if (i < min || i > max) return null;
    return i;
  }

  function showAdmin() {
    loginCard.style.display = "none";
    adminApp.style.display = "block";
  }

  function showLogin() {
    adminApp.style.display = "none";
    loginCard.style.display = "block";
  }

  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) throw new Error("Ikke innlogget");
    return session;
  }

  async function loadMyOlsmakinger() {
    const session = await requireAuth();

    const { data, error } = await supabase
            .from("tastings")
            .select("id, title, total_beers, revealed, created_at")
            .eq("created_by", session.user.id)
            .order("created_at", { ascending: false });

    if (error) throw error;

    olsSelect.innerHTML =
            `<option value="">Velg‚Ä¶</option>` +
            (data ?? []).map(o => `<option value="${o.id}">${o.title} (N=${o.total_beers})</option>`).join("");
  }

  async function loadOlsMeta(id) {
    const { data, error } = await supabase
            .from("tastings")
            .select("title, total_beers, revealed, current_beer_no")
            .eq("id", id)
            .single();

    currentBeerText.textContent = `√òl #${data.current_beer_no} / ${data.total_beers}`;

    if (error) throw error;

    titleEl.value = data.title;
    totalBeersEl.value = data.total_beers;
    revealPill.textContent = data.revealed ? "REVEALED ‚úÖ" : "SKJULT üîí";
    olsStatus.textContent = `Valgt: ${data.title}`;
  }

  async function setCurrentBeer(newNo) {
    if (!currentOlsId) return;

    const n = clampInt(totalBeersEl.value, 1, 200);
    if (n === null) return alert("Sett N f√∏rst (1‚Äì200)");

    if (newNo < 1) newNo = 1;
    if (newNo > n) newNo = n;

    const { error } = await supabase
            .from("tastings")
            .update({ current_beer_no: newNo })
            .eq("id", currentOlsId);

    if (error) return alert(error.message);

    await loadOlsMeta(currentOlsId);
  }

  document.querySelector("#nextBeer").addEventListener("click", async () => {
    try {
      await requireAuth();
      if (!currentOlsId) return alert("Velg √∏lsmaking f√∏rst");

      const { data, error } = await supabase
              .from("tastings")
              .select("current_beer_no")
              .eq("id", currentOlsId)
              .single();
      if (error) throw error;

      await setCurrentBeer((data.current_beer_no ?? 1) + 1);
    } catch (e) { alert(e.message); }
  });

  document.querySelector("#prevBeer").addEventListener("click", async () => {
    try {
      await requireAuth();
      if (!currentOlsId) return alert("Velg √∏lsmaking f√∏rst");

      const { data, error } = await supabase
              .from("tastings")
              .select("current_beer_no")
              .eq("id", currentOlsId)
              .single();
      if (error) throw error;

      await setCurrentBeer((data.current_beer_no ?? 1) - 1);
    } catch (e) { alert(e.message); }
  });


  async function refreshBeers() {
    const { data, error } = await supabase
            .from("beers")
            .select("beer_no, name")
            .eq("tasting_id", currentOlsId)
            .order("beer_no");

    if (error) throw error;

    beerRows.innerHTML = "";
    for (const b of data ?? []) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${b.beer_no}</td><td>${b.name}</td>`;
      beerRows.appendChild(tr);
    }
  }

  document.querySelector("#login").addEventListener("click", async () => {
    try {
      loginStatus.textContent = "Logger inn‚Ä¶";
      const email = document.querySelector("#email").value.trim();
      const pass = document.querySelector("#pass").value;

      const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;

      showAdmin();
      await loadMyOlsmakinger();
      olsStatus.textContent = "Velg eller opprett √∏lsmaking.";
    } catch (e) {
      alert(e.message);
      loginStatus.textContent = "Feil ved innlogging";
    }
  });

  document.querySelector("#logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    showLogin();
  });

  olsSelect.addEventListener("change", async () => {
    currentOlsId = olsSelect.value || null;
    if (!currentOlsId) return;
    await loadOlsMeta(currentOlsId);
    await refreshBeers();
  });

  const currentBeerText = document.querySelector("#currentBeerText");

  document.querySelector("#createOls").addEventListener("click", async () => {
    const title = (titleEl.value || "Jule√∏l-test").trim();
    const n = clampInt(totalBeersEl.value, 1, 200);
    if (n === null) return alert("N m√• v√¶re 1‚Äì200");

    const { data, error } = await supabase
            .from("tastings")
            .insert({ title, total_beers: n, revealed: false })
            .select("id")
            .single();

    if (error) return alert(error.message);

    await loadMyOlsmakinger();
    olsSelect.value = data.id;
    currentOlsId = data.id;
    await loadOlsMeta(data.id);
    await refreshBeers();
  });

  document.querySelector("#saveMeta").addEventListener("click", async () => {
    if (!currentOlsId) return alert("Velg √∏lsmaking");

    const title = titleEl.value.trim();
    const n = clampInt(totalBeersEl.value, 1, 200);
    if (n === null) return alert("N m√• v√¶re 1‚Äì200");

    const { error } = await supabase
            .from("tastings")
            .update({ title, total_beers: n })
            .eq("id", currentOlsId);

    if (error) return alert(error.message);
    await loadMyOlsmakinger();
    await loadOlsMeta(currentOlsId);
    olsStatus.textContent = "Oppdatert ‚úÖ";
  });

  document.querySelector("#saveBeer").addEventListener("click", async () => {
    if (!currentOlsId) return alert("Velg √∏lsmaking");

    const beerNo = clampInt(document.querySelector("#beerNo").value, 1, 9999);
    const beerName = document.querySelector("#beerName").value.trim();
    if (beerNo === null || !beerName) return alert("Ugyldig input");

    const { error } = await supabase
            .from("beers")
            .upsert({ tasting_id: currentOlsId, beer_no: beerNo, name: beerName },
                    { onConflict: "tasting_id,beer_no" });

    if (error) return alert(error.message);

    document.querySelector("#beerName").value = "";
    await refreshBeers();
  });

  document.querySelector("#reveal").addEventListener("click", async () => {
    if (!currentOlsId) return alert("Velg √∏lsmaking");
    if (!confirm("Reveal n√•?")) return;

    const { error } = await supabase
            .from("tastings")
            .update({ revealed: true })
            .eq("id", currentOlsId);

    if (error) return alert(error.message);

    await loadOlsMeta(currentOlsId);
  });

  // Init
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      showAdmin();
      await loadMyOlsmakinger();
    } else {
      showLogin();
    }
  })();
</script>
</body>
</html>
